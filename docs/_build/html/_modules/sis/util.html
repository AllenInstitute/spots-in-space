<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sis.util &#8212; Spots-in-Spaaaaaace! 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for sis.util</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">pathlib</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">scipy.io</span> <span class="kn">import</span> <span class="n">mmwrite</span><span class="p">,</span><span class="n">mmread</span>
<span class="kn">import</span> <span class="nn">scanpy</span> <span class="k">as</span> <span class="nn">sc</span>
<span class="kn">import</span> <span class="nn">gzip</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">from</span> <span class="nn">zipfile</span> <span class="kn">import</span> <span class="n">ZipFile</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">shapely</span> <span class="kn">import</span> <span class="n">coverage_union_all</span>
<span class="kn">import</span> <span class="nn">shapely</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>


<div class="viewcode-block" id="reduce_expression">
<a class="viewcode-back" href="../../sis.html#sis.util.reduce_expression">[docs]</a>
<span class="k">def</span> <span class="nf">reduce_expression</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">umap_args</span><span class="p">):</span>
    <span class="kn">import</span> <span class="nn">umap</span>
    <span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

    <span class="n">default_umap_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;n_neighbors&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;min_dist&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">,</span> <span class="s1">&#39;n_components&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">}</span>
    <span class="n">default_umap_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">umap_args</span><span class="p">)</span>

    <span class="n">flat_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

    <span class="c1"># randomize order (because umap has some order-dependent effects)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">flat_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="n">flat_data</span> <span class="o">=</span> <span class="n">flat_data</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>

    <span class="c1"># remove rows with no transcripts</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">flat_data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>
    <span class="n">masked_data</span> <span class="o">=</span> <span class="n">flat_data</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="c1"># scale in prep for umap</span>
    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">masked_data</span><span class="p">)</span>

    <span class="c1"># reduce down to 3D</span>
    <span class="n">reducer</span> <span class="o">=</span> <span class="n">umap</span><span class="o">.</span><span class="n">UMAP</span><span class="p">(</span><span class="o">**</span><span class="n">default_umap_args</span><span class="p">)</span>
    <span class="n">reduced</span> <span class="o">=</span> <span class="n">reducer</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">scaled</span><span class="p">)</span>

    <span class="c1"># re-insert rows with no transcripts (all 0)</span>
    <span class="n">final</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">flat_data</span><span class="p">),</span> <span class="n">reduced</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">reduced</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
    <span class="n">final</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">reduced</span>

    <span class="c1"># un-shuffle order</span>
    <span class="n">reverse_order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">order</span><span class="p">)</span>
    <span class="n">final</span> <span class="o">=</span> <span class="n">final</span><span class="p">[</span><span class="n">reverse_order</span><span class="p">]</span>

    <span class="c1"># return reshaped to original image</span>
    <span class="k">return</span> <span class="n">final</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">final</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span></div>



<div class="viewcode-block" id="map_to_ubyte">
<a class="viewcode-back" href="../../sis.html#sis.util.map_to_ubyte">[docs]</a>
<span class="k">def</span> <span class="nf">map_to_ubyte</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="n">mn</span><span class="p">,</span> <span class="n">mx</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">data</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">((</span><span class="n">data</span> <span class="o">-</span> <span class="n">mn</span><span class="p">)</span> <span class="o">*</span> <span class="mi">255</span> <span class="o">/</span> <span class="p">(</span><span class="n">mx</span> <span class="o">-</span> <span class="n">mn</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;ubyte&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="rainbow_wheel">
<a class="viewcode-back" href="../../sis.html#sis.util.rainbow_wheel">[docs]</a>
<span class="k">def</span> <span class="nf">rainbow_wheel</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">center</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">radius</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">center_color</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Given an Nx2 array of point locations, return an Nx3 array of RGB</span>
<span class="sd">    colors derived from a rainbow color wheel centered over the mean point location.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
    <span class="kn">import</span> <span class="nn">scipy.interpolate</span>
    <span class="n">flat</span> <span class="o">=</span> <span class="n">points</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">center</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">flat</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">radius</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">radius</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">flat</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">f</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">radius</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">center</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">radius</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span> <span class="o">+</span> <span class="n">center</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">gist_rainbow</span><span class="p">(</span><span class="n">f</span><span class="p">)[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">center_color</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">center</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">c</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">center_color</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="n">color</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">griddata</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">flat</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">fill_value</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">color</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">points</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,))</span></div>



<div class="viewcode-block" id="show_float_rgb">
<a class="viewcode-back" href="../../sis.html#sis.util.show_float_rgb">[docs]</a>
<span class="k">def</span> <span class="nf">show_float_rgb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">extent</span><span class="p">,</span> <span class="n">ax</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Show a color image given a WxHx3 array of floats.</span>
<span class="sd">    Each channel is normalized independently.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rgb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span><span class="p">,),</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;ubyte&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
        <span class="n">rgb</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">map_to_ubyte</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">i</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">rgb</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">extent</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">)</span></div>



<div class="viewcode-block" id="log_plus_1">
<a class="viewcode-back" href="../../sis.html#sis.util.log_plus_1">[docs]</a>
<span class="k">def</span> <span class="nf">log_plus_1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="poly_to_geojson">
<a class="viewcode-back" href="../../sis.html#sis.util.poly_to_geojson">[docs]</a>
<span class="k">def</span> <span class="nf">poly_to_geojson</span><span class="p">(</span><span class="n">polygon</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    turns a single shapely Polygon into a geojson polygon</span>
<span class="sd">    Args:</span>
<span class="sd">        polygon shapely.Polygon</span>
<span class="sd">    Returns:</span>
<span class="sd">        geojson polygon</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">geojson</span>
    <span class="n">poly_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">polygon</span><span class="o">.</span><span class="n">exterior</span><span class="o">.</span><span class="n">coords</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">geojson</span><span class="o">.</span><span class="n">Polygon</span><span class="p">([[(</span><span class="n">poly_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">poly_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">poly_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]])</span></div>



<div class="viewcode-block" id="load_config">
<a class="viewcode-back" href="../../sis.html#sis.util.load_config">[docs]</a>
<span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="n">configfile</span><span class="p">:</span> <span class="nb">str</span><span class="o">|</span><span class="n">Path</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    loads configuration yaml file for spatial analysis. If no file is found, returns empty dict</span>

<span class="sd">    Args:</span>
<span class="sd">        configfile: path to yaml file. If None, will look for spatial_config.yml in the directory above this file </span>
<span class="sd">    Returns:</span>
<span class="sd">        dict of configuration parameters</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">yaml</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">configfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">configfile</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">configfile</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span><span class="o">.</span><span class="n">parents</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;spatial_config.yml&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">configfile</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="n">configfile</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">yaml</span><span class="p">,</span> <span class="s1">&#39;FullLoader&#39;</span><span class="p">):</span>
            <span class="c1"># pyyaml new API</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">configfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">),</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># pyyaml old API</span>
            <span class="n">config</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">configfile</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">return</span> <span class="n">config</span></div>



<div class="viewcode-block" id="package_for_10x">
<a class="viewcode-back" href="../../sis.html#sis.util.package_for_10x">[docs]</a>
<span class="k">def</span> <span class="nf">package_for_10x</span><span class="p">(</span><span class="n">anndata_object</span><span class="p">,</span>
                    <span class="n">output_directory</span><span class="p">,</span>
                    <span class="n">gene_id_var_list</span><span class="p">,</span> 
                    <span class="n">dry_run</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                    <span class="n">exist_ok</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">annotation_category</span><span class="o">=</span><span class="s2">&quot;Supertype&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    takes a reference dataset as anndata object and writes a reference file that can be uploaded</span>
<span class="sd">    to 10x as a reference for  Xenium  gene panel selection</span>
<span class="sd">    see https://www.10xgenomics.com/support/in-situ-gene-expression/documentation/steps/panel-design/xenium-panel-getting-started#input-ref-anno</span>


<span class="sd">    keyword arguments dry_run and exist_ok may help you avoid overwriting something important</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># organize some paths:</span>
    <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="n">exist_ok</span><span class="p">)</span>
    <span class="n">zip_path</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_directory</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">output_directory</span><span class="o">.</span><span class="n">stem</span><span class="o">+</span><span class="s2">&quot;_to_zip&quot;</span><span class="p">)</span>
    <span class="n">zip_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span> <span class="o">=</span> <span class="n">exist_ok</span><span class="p">)</span>
    <span class="n">matrix_output_path</span> <span class="o">=</span> <span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span> <span class="s2">&quot;matrix.mtx&quot;</span><span class="p">)</span>
    <span class="n">barcodes_output_path</span> <span class="o">=</span> <span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span> <span class="s2">&quot;barcodes.tsv&quot;</span><span class="p">)</span>
    <span class="n">features_output_path</span> <span class="o">=</span> <span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span> <span class="s2">&quot;features.tsv&quot;</span> <span class="p">)</span>
    <span class="n">annotation_output_path</span> <span class="o">=</span><span class="n">output_directory</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s2">&quot;annotation.csv&quot;</span><span class="p">)</span>
    <span class="c1"># Going for MEX format here:</span>

    <span class="c1"># confirmed this matches after reading it back in, although the read in is float64</span>

    <span class="c1"># barcodes.tsv</span>


    <span class="c1"># features.tsv.gz</span>
    <span class="c1"># The file is expected to conform to the specification outlined under MEX format here, namely:</span>

    <span class="c1">#     Tab delimited</span>
    <span class="c1">#     No header column</span>
    <span class="c1">#     Ensembl IDs, followed by gene symbols, optionally followed by a feature type</span>
    <span class="c1"># </span>
    <span class="c1"># ENSG00000141510       TP53         Gene Expression</span>
    <span class="c1"># ENSG00000012048       BRCA1        Gene Expression</span>
    <span class="c1"># ENSG00000139687       RB1          Gene Expression</span>



    <span class="n">features_tsv</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">anndata_object</span><span class="o">.</span><span class="n">var_names</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;Gene Symbol&quot;</span><span class="p">])</span>
    <span class="n">features_tsv</span><span class="p">[</span><span class="s2">&quot;Ensembl IDs&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">gene_id_var_list</span>
    <span class="n">features_tsv</span> <span class="o">=</span> <span class="n">features_tsv</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s2">&quot;Ensembl IDs&quot;</span><span class="p">,</span><span class="s2">&quot;Gene Symbol&quot;</span><span class="p">]]</span>
    <span class="c1"># annotations.csv  needs #barcode column and #annotation column:</span>
    <span class="n">tout_annotations</span> <span class="o">=</span> <span class="n">anndata_object</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">tout_annotations</span><span class="p">[</span><span class="s2">&quot;barcode&quot;</span><span class="p">]</span><span class="o">=</span> <span class="n">tout_annotations</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span>
    <span class="n">tout_annotations</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span><span class="o">=</span> <span class="n">tout_annotations</span><span class="p">[</span><span class="n">annotation_category</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
    
    <span class="c1">#actual writing to files:</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">dry_run</span><span class="p">:</span>
        <span class="c1"># matrix.mtx.gz</span>
        <span class="n">mmwrite</span><span class="p">(</span><span class="n">matrix_output_path</span><span class="p">,</span> <span class="n">anndata_object</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s2">&quot;UMIs&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

        <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">anndata_object</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">barcodes_output_path</span><span class="p">,</span> <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">features_tsv</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">features_output_path</span><span class="p">,</span>   <span class="n">sep</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\t</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">tout_annotations</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,[</span><span class="s2">&quot;barcode&quot;</span><span class="p">,</span><span class="s2">&quot;annotation&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">annotation_output_path</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        
        <span class="c1"># compress individual files:</span>
        <span class="n">files_in_target</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="p">[</span><span class="n">barcodes_output_path</span><span class="p">,</span> <span class="n">features_output_path</span><span class="p">,</span> <span class="n">matrix_output_path</span><span class="p">]:</span>
            <span class="n">file_in_target</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">zip_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file</span><span class="o">.</span><span class="n">name</span><span class="p">))</span><span class="o">+</span><span class="s2">&quot;.gz&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">,</span><span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">to_zip</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">gzip</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">file_in_target</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">zip_out</span><span class="p">:</span>
                    <span class="n">shutil</span><span class="o">.</span><span class="n">copyfileobj</span><span class="p">(</span><span class="n">to_zip</span><span class="p">,</span> <span class="n">zip_out</span><span class="p">)</span>
                    <span class="n">files_in_target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">file_in_target</span><span class="p">)</span>
        <span class="c1"># copy over the annotation:</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">copyfile</span><span class="p">(</span><span class="n">annotation_output_path</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">zip_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">annotation_output_path</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
        <span class="n">files_in_target</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zip_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">annotation_output_path</span><span class="o">.</span><span class="n">name</span><span class="p">)))</span>
        <span class="c1"># then zip the whole directory:</span>
        <span class="k">with</span> <span class="n">ZipFile</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">zip_path</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.zip&quot;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">final_zip</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files_in_target</span><span class="p">:</span>
                <span class="n">final_zip</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">arcname</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                
        
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">features_tsv</span></div>


<div class="viewcode-block" id="plot_genes">
<a class="viewcode-back" href="../../sis.html#sis.util.plot_genes">[docs]</a>
<span class="k">def</span> <span class="nf">plot_genes</span><span class="p">(</span><span class="n">spottable</span><span class="p">,</span>  <span class="n">gene_list</span><span class="p">,</span> 
               <span class="n">min_counts</span><span class="p">,</span><span class="n">highlight_list</span> <span class="o">=</span> <span class="p">[],</span> 
               <span class="n">subsample</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
               <span class="n">figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span><span class="mi">15</span><span class="p">],</span> 
               <span class="n">transpose_plot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color_background</span> <span class="o">=</span><span class="p">[</span><span class="mf">.65</span><span class="p">,</span><span class="mf">.65</span><span class="p">,</span><span class="mf">.65</span><span class="p">],</span>
               <span class="n">markersize_background</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span> <span class="n">markersize_highlight</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
               <span class="n">color_start</span> <span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">incoming_ax</span> <span class="o">=</span> <span class="kc">None</span> <span class="p">):</span>
    
    
    <span class="n">first_background</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">no_gray</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="o">.</span><span class="n">colors</span><span class="p">[:</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">no_gray</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">8</span><span class="p">:])</span>
    <span class="n">no_gray</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">no_gray</span><span class="p">),[</span><span class="n">color_start</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
    
    <span class="k">if</span> <span class="n">incoming_ax</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">=</span> <span class="n">incoming_ax</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_prop_cycle</span><span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="n">no_gray</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gene_list</span><span class="p">:</span>
        <span class="n">gmask</span> <span class="o">=</span> <span class="n">spottable</span><span class="o">.</span><span class="n">gene_names</span><span class="o">==</span><span class="n">g</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gmask</span><span class="p">)</span> <span class="o">&gt;</span><span class="n">min_counts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">highlight_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">transpose_plot</span><span class="p">:</span>
                    <span class="n">toploty</span> <span class="o">=</span> <span class="n">spottable</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">gmask</span><span class="p">][::</span><span class="n">subsample</span><span class="p">]</span>
                    <span class="n">toplotx</span> <span class="o">=</span> <span class="n">spottable</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">gmask</span><span class="p">][::</span><span class="n">subsample</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">toplotx</span> <span class="o">=</span> <span class="n">spottable</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">gmask</span><span class="p">][::</span><span class="n">subsample</span><span class="p">]</span>
                    <span class="n">toploty</span> <span class="o">=</span> <span class="n">spottable</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">gmask</span><span class="p">][::</span><span class="n">subsample</span><span class="p">]</span>                   
                <span class="k">if</span> <span class="n">first_background</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">toplotx</span><span class="p">,</span> <span class="n">toploty</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">color_background</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="n">markersize_background</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;other_genes&quot;</span><span class="p">)</span>
                    <span class="n">first_background</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">toplotx</span><span class="p">,</span> <span class="n">toploty</span><span class="p">,</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span> <span class="o">=</span> <span class="n">color_background</span><span class="p">,</span><span class="n">markersize</span><span class="o">=</span><span class="n">markersize_background</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">gene_list</span><span class="p">:</span>
        <span class="n">gmask</span> <span class="o">=</span> <span class="n">spottable</span><span class="o">.</span><span class="n">gene_names</span><span class="o">==</span><span class="n">g</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gmask</span><span class="p">)</span> <span class="o">&gt;</span><span class="n">min_counts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">highlight_list</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">transpose_plot</span><span class="p">:</span>
                    <span class="n">toploty</span> <span class="o">=</span> <span class="n">spottable</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">gmask</span><span class="p">][::</span><span class="n">subsample</span><span class="p">]</span>
                    <span class="n">toplotx</span> <span class="o">=</span> <span class="n">spottable</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">gmask</span><span class="p">][::</span><span class="n">subsample</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">toplotx</span> <span class="o">=</span> <span class="n">spottable</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">gmask</span><span class="p">][::</span><span class="n">subsample</span><span class="p">]</span>
                    <span class="n">toploty</span> <span class="o">=</span> <span class="n">spottable</span><span class="o">.</span><span class="n">y</span><span class="p">[</span><span class="n">gmask</span><span class="p">][::</span><span class="n">subsample</span><span class="p">]</span> 
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">toplotx</span><span class="p">,</span> <span class="n">toploty</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">g</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">markersize_highlight</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">,</span> <span class="n">markerscale</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span></div>




    
<div class="viewcode-block" id="show_cells_and_transcripts">
<a class="viewcode-back" href="../../sis.html#sis.util.show_cells_and_transcripts">[docs]</a>
<span class="k">def</span> <span class="nf">show_cells_and_transcripts</span><span class="p">(</span><span class="n">spottable</span><span class="p">,</span> <span class="n">anndata_obj</span><span class="p">,</span>
                               <span class="n">segmentation_geopandas</span><span class="p">,</span>
                               <span class="n">genes_to_highlight</span><span class="o">=</span><span class="p">[],</span>
                               <span class="n">cell_annotation_category</span> <span class="o">=</span> <span class="s2">&quot;supertype_scANVI_leiden&quot;</span><span class="p">,</span>
                               <span class="n">cell_annotation_values</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">cell_annotation_values_background</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">cell_annotation_colormapping</span><span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">plot_blanks</span> <span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">loaded_image_array</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">loaded_image_extent</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                               <span class="n">initial_figsize</span><span class="o">=</span><span class="p">[</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">],</span>
                               <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">image_cmap</span><span class="o">=</span><span class="s2">&quot;Greys&quot;</span><span class="p">,</span>
                               <span class="n">selected_cell_outline_weight</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                               <span class="n">plot_patches</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">skip_genes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters:</span>
<span class="sd">    </span>
<span class="sd">    loaded_image_array</span>
<span class="sd">    </span>
<span class="sd">    will take a 2D numpy array and use it for background. otherwise a maximum projection of image data from the SpotTable is created and used.</span>
<span class="sd">    </span>
<span class="sd">    cell_annotation_category</span>
<span class="sd">    </span>
<span class="sd">    column in anndata_obj.obs to get annotation information from</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    cell_annotation_values </span>
<span class="sd">    </span>
<span class="sd">    values in `cell_annotation_category` to show</span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    **kwargs are passed to `plot_genes`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">geopandas</span> <span class="k">as</span> <span class="nn">gpd</span>


    <span class="n">no_gray2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">7</span><span class="p">])</span>
    <span class="n">no_gray2</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">tab10</span><span class="o">.</span><span class="n">colors</span><span class="p">[</span><span class="mi">8</span><span class="p">:])</span>
    <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">no_gray2</span><span class="p">),[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>




    <span class="c1"># get image data and show it.</span>
    <span class="n">plot_image</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">loaded_image_array</span><span class="p">,</span><span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)):</span>

        <span class="n">spot_table_im</span> <span class="o">=</span><span class="n">spottable</span><span class="o">.</span><span class="n">get_image</span><span class="p">(</span><span class="n">channel</span><span class="o">=</span><span class="s2">&quot;DAPI&quot;</span><span class="p">)</span>

        <span class="n">image_data</span> <span class="o">=</span> <span class="n">spot_table_im</span><span class="o">.</span><span class="n">get_data</span><span class="p">()</span>
        <span class="c1"># return max projection over z, transposed and flipped vertically for display</span>
        <span class="n">loaded_image_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">image_data</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span>
        <span class="n">loaded_image_extent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spot_table_im</span><span class="o">.</span><span class="n">bounds</span><span class="p">())[::</span><span class="o">-</span><span class="mi">1</span><span class="p">,:]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">plot_image</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># check input types pls</span>
        <span class="k">pass</span>

    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">initial_figsize</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">plot_image</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">loaded_image_array</span><span class="p">,</span> <span class="n">extent</span><span class="o">=</span><span class="n">loaded_image_extent</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">image_cmap</span><span class="p">,</span> <span class="n">vmax</span> <span class="o">=</span> <span class="mf">0.8</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">loaded_image_array</span><span class="p">))</span>   

    <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
    <span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spottable</span><span class="o">.</span><span class="n">gene_names</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">plot_blanks</span><span class="p">:</span>
        <span class="n">gene_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">gene_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">targets</span> <span class="k">if</span> <span class="s2">&quot;Blank-&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="p">]</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">skip_genes</span><span class="p">:</span>
        <span class="n">plot_genes</span><span class="p">(</span><span class="n">spottable</span><span class="p">,</span><span class="n">gene_list</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
               <span class="n">highlight_list</span> <span class="o">=</span><span class="n">genes_to_highlight</span><span class="p">,</span><span class="n">figsize</span><span class="o">=</span><span class="n">initial_figsize</span><span class="p">,</span> <span class="n">incoming_ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>



    <span class="c1"># plot cell perimeters and gather centroids along the way</span>
    <span class="c1"># this particular case (2D segmentation on 3d data) means that we have 7 copies of each segmentation polygon (and 7 centroids for each cell)</span>
    <span class="c1"># to deal with this, I&#39;m going to take only the 0th polygon for each unique cell id.</span>
    <span class="c1"># in the case where there is full 3D segmentation, it should show up plotted below and the centroids should still be reasonably accurate</span>






    <span class="c1"># add mapped cell identities:</span>
    <span class="c1"># suboptimal copy here</span>
    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">anndata_obj</span><span class="p">)</span> <span class="o">==</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">:</span>
        <span class="n">anno</span> <span class="o">=</span> <span class="n">anndata_obj</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">anno</span><span class="p">[</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">anno</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>   





    <span class="k">if</span> <span class="n">cell_annotation_colormapping</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plotted_categories</span><span class="o">=</span><span class="p">{</span><span class="n">pc</span><span class="p">:{</span><span class="s2">&quot;plotted&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
                                <span class="s2">&quot;color&quot;</span><span class="p">:</span><span class="n">no_gray2</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span>
                                <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span><span class="n">selected_cell_outline_weight</span><span class="p">,</span>
                               <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span><span class="s1">&#39;k&#39;</span><span class="p">}</span> <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">pc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_annotation_values</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plotted_categories</span><span class="o">=</span><span class="p">{</span><span class="n">pc</span><span class="p">:{</span><span class="s2">&quot;plotted&quot;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span>
                                <span class="s2">&quot;color&quot;</span><span class="p">:</span><span class="n">cell_annotation_colormapping</span><span class="p">[</span><span class="n">pc</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                               <span class="s2">&quot;linewidth&quot;</span><span class="p">:</span><span class="n">cell_annotation_colormapping</span><span class="p">[</span><span class="n">pc</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                               <span class="s2">&quot;edgecolor&quot;</span><span class="p">:</span><span class="n">cell_annotation_colormapping</span><span class="p">[</span><span class="n">pc</span><span class="p">][</span><span class="mi">2</span><span class="p">]}</span>
                            <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">pc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">anno</span><span class="p">[</span><span class="n">cell_annotation_category</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()))}</span>


    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">segmentation_geopandas</span><span class="p">)</span> <span class="o">==</span> <span class="n">gpd</span><span class="o">.</span><span class="n">geodataframe</span><span class="o">.</span><span class="n">GeoDataFrame</span> <span class="p">:</span>


        <span class="k">for</span> <span class="n">cellid</span> <span class="ow">in</span> <span class="n">segmentation_geopandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segmentation_geopandas</span><span class="o">.</span><span class="n">EntityID</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">spottable</span><span class="o">.</span><span class="n">cell_ids</span><span class="p">),[</span><span class="s2">&quot;EntityID&quot;</span><span class="p">,</span><span class="s2">&quot;Geometry&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">EntityID</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">cellinfo</span> <span class="o">=</span> <span class="n">segmentation_geopandas</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">segmentation_geopandas</span><span class="o">.</span><span class="n">EntityID</span><span class="o">==</span><span class="n">cellid</span><span class="p">,</span><span class="s2">&quot;Geometry&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">tg</span> <span class="o">=</span> <span class="n">coverage_union_all</span><span class="p">(</span><span class="n">cellinfo</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">tg</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">Polygon</span><span class="p">):</span>
                    <span class="n">x_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tg</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">y_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">tg</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">tg</span><span class="p">,</span> <span class="n">shapely</span><span class="o">.</span><span class="n">MultiPolygon</span><span class="p">):</span>
                    <span class="c1"># these are multiple polygons. take the largest. TODO: find out how this happens...</span>
                    <span class="n">geo_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">g</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">tg</span><span class="o">.</span><span class="n">geoms</span><span class="p">]</span>
                    <span class="n">largest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">([</span><span class="n">g</span><span class="o">.</span><span class="n">area</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">geo_list</span><span class="p">])</span>
                    <span class="n">x_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geo_list</span><span class="p">[</span><span class="n">largest</span><span class="p">]</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">y_coords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">geo_list</span><span class="p">[</span><span class="n">largest</span><span class="p">]</span><span class="o">.</span><span class="n">boundary</span><span class="o">.</span><span class="n">coords</span><span class="o">.</span><span class="n">xy</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>                
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cellid</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;   is neither Polygon nor MultiPolygon&quot;</span><span class="p">)</span>
                    <span class="k">continue</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">cellid</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;   failed decomposition&quot;</span><span class="p">)</span>
                <span class="k">continue</span>               
  
            <span class="k">if</span> <span class="n">cellid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">anno</span><span class="p">[</span><span class="n">cell_annotation_category</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cell_annotation_values</span><span class="p">),</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">anno_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_annotation_values</span><span class="p">):</span>
                    <span class="n">anno_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">anno</span><span class="p">[</span><span class="n">cell_annotation_category</span><span class="p">]</span><span class="o">==</span><span class="n">anno_value</span><span class="p">,</span><span class="s2">&quot;cell_id&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">cellid</span> <span class="ow">in</span> <span class="n">anno_list</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;plotted&quot;</span><span class="p">]:</span>
                            <span class="c1"># first time through, include label for legend</span>
                            <span class="k">if</span> <span class="n">plot_patches</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> 
                                    <span class="n">facecolor</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                                         <span class="n">linewidth</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
                                         <span class="n">edgecolor</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">],</span>
                                         <span class="n">label</span> <span class="o">=</span> <span class="n">anno_value</span><span class="p">)</span>
                                <span class="c1"># with thin boundary</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span>
                                         <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mf">.2</span><span class="p">,</span><span class="mf">.2</span><span class="p">,</span><span class="mf">.2</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> 
                                    <span class="n">color</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                                    <span class="n">linewidth</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
                                    <span class="n">label</span> <span class="o">=</span> <span class="n">anno_value</span><span class="p">)</span>
                            <span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;plotted&quot;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># other times through, do not include label for legend</span>
                            <span class="k">if</span> <span class="n">plot_patches</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> 
                                 <span class="n">facecolor</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                                         <span class="n">linewidth</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
                                         <span class="n">edgecolor</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">],</span>
                                         <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>
                                <span class="c1"># with added thin boundary</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span>
                                         <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mf">.2</span><span class="p">,</span><span class="mf">.2</span><span class="p">,</span><span class="mf">.2</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>

                                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                                         <span class="n">linewidth</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
                                         <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>


            <span class="k">elif</span> <span class="n">cellid</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">anno</span><span class="p">[</span><span class="n">cell_annotation_category</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">cell_annotation_values_background</span><span class="p">),</span><span class="s2">&quot;cell_id&quot;</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">anno_value</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">cell_annotation_values_background</span><span class="p">):</span>
                    <span class="n">anno_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">anno</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">anno</span><span class="p">[</span><span class="n">cell_annotation_category</span><span class="p">]</span><span class="o">==</span><span class="n">anno_value</span><span class="p">,</span><span class="s2">&quot;cell_id&quot;</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">cellid</span> <span class="ow">in</span> <span class="n">anno_list</span> <span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;plotted&quot;</span><span class="p">]:</span>
                            <span class="c1"># first time through, include label for legend</span>
                            <span class="k">if</span> <span class="n">plot_patches</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> 
                                    <span class="n">facecolor</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                                         <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">edgecolor</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">],</span>
                                         <span class="n">label</span> <span class="o">=</span> <span class="n">anno_value</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> 
                                    <span class="n">color</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                                    <span class="n">linewidth</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
                                    <span class="n">label</span> <span class="o">=</span> <span class="n">anno_value</span><span class="p">)</span>
                            <span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;plotted&quot;</span><span class="p">]</span><span class="o">=</span><span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># other times through, do not include label for legend</span>
                            <span class="k">if</span> <span class="n">plot_patches</span><span class="p">:</span>
                                <span class="n">plt</span><span class="o">.</span><span class="n">fill</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> 
                                 <span class="n">facecolor</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                                         <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                         <span class="n">edgecolor</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;edgecolor&quot;</span><span class="p">],</span>
                                         <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>

                            <span class="k">else</span><span class="p">:</span>

                                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span> 
                                 <span class="n">color</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;color&quot;</span><span class="p">],</span>
                                         <span class="n">linewidth</span><span class="o">=</span><span class="n">plotted_categories</span><span class="p">[</span><span class="n">anno_value</span><span class="p">][</span><span class="s2">&quot;linewidth&quot;</span><span class="p">],</span>
                                         <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span>


            <span class="c1">#add thin outlines to everything?</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_coords</span><span class="p">,</span> <span class="n">y_coords</span><span class="p">,</span>
                         <span class="n">color</span><span class="o">=</span><span class="p">[</span><span class="mf">.2</span><span class="p">,</span><span class="mf">.2</span><span class="p">,</span><span class="mf">.2</span><span class="p">],</span><span class="n">linewidth</span><span class="o">=</span><span class="mf">.5</span><span class="p">)</span>
<span class="c1">#             except:</span>
<span class="c1">#                 print(&quot;skipping plot of &quot;+str(cellid))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span></div>

    <span class="c1"># could be useful at some point: get polygons from spotdata:</span>
    <span class="c1"># for k in list(mini.cell_polygons.keys()):</span>
    <span class="c1">#     if mini.cell_polygons[k] == None:</span>
    <span class="c1">#         continue</span>
    <span class="c1">#     if mini.cell_polygons[k].boundary == None:</span>
    <span class="c1">#         continue</span>
    <span class="c1">#     plt.plot(list(mini.cell_polygons[k].boundary.coords.xy[1]), list(mini.cell_polygons[k].boundary.coords.xy[0]))</span>


    
<div class="viewcode-block" id="plot_cbg_centroids">
<a class="viewcode-back" href="../../sis.html#sis.util.plot_cbg_centroids">[docs]</a>
<span class="k">def</span> <span class="nf">plot_cbg_centroids</span><span class="p">(</span><span class="n">cell_by_gene</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;center_x&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;center_y&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">cell_by_gene</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">,</span> <span class="n">adjustable</span><span class="o">=</span><span class="s1">&#39;box&#39;</span><span class="p">,</span> <span class="n">anchor</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">g</span> </div>



<div class="viewcode-block" id="example_function">
<a class="viewcode-back" href="../../sis.html#sis.util.example_function">[docs]</a>
<span class="k">def</span> <span class="nf">example_function</span><span class="p">():</span>
    <span class="k">return</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="make_cirro_compatible">
<a class="viewcode-back" href="../../sis.html#sis.util.make_cirro_compatible">[docs]</a>
<span class="k">def</span> <span class="nf">make_cirro_compatible</span><span class="p">(</span><span class="n">cell_by_gene</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;Make an AnnData object compatible with Cirrocumulus visualization tool.</span>
<span class="sd">    </span>
<span class="sd">    Copy cell spatial coordinates to obsm, as expected by Cirrocumulus</span>
<span class="sd">    (https://cirrocumulus.readthedocs.io). Also, generate UMAP from .X as an </span>
<span class="sd">    additional visualization option.</span>

<span class="sd">    Parameters:</span>
<span class="sd">        cell_by_gene: AnnData object output by </span>
<span class="sd">                      sis.spot_table.cell_by_gene_anndata()</span>

<span class="sd">    Returns:</span>
<span class="sd">        cell_by_gene_cirro: copy of cell_by_gene with cirrocumulus-compatible fields</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c1"># confirm AnnData is in correct format</span>
    <span class="n">assert_message</span> <span class="o">=</span> <span class="s1">&#39;cell_by_gene obs columns must match format output by sis.spot_table.cell_by_gene_anndata()&#39;</span> 
    <span class="k">assert</span> <span class="p">{</span><span class="s1">&#39;center_x&#39;</span><span class="p">,</span><span class="s1">&#39;center_y&#39;</span><span class="p">,</span><span class="s1">&#39;center_z&#39;</span><span class="p">}</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">cell_by_gene</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="n">assert_message</span>

    <span class="n">cell_by_gene_cirro</span> <span class="o">=</span> <span class="n">cell_by_gene</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="c1"># Copy cell coordinates to obsm</span>
    <span class="n">cell_by_gene_cirro</span><span class="o">.</span><span class="n">obsm</span><span class="p">[</span><span class="s1">&#39;spatial&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_by_gene_cirro</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span>
                                                                <span class="p">[</span><span class="s1">&#39;center_x&#39;</span><span class="p">,</span> 
                                                                <span class="s1">&#39;center_y&#39;</span><span class="p">,</span> 
                                                                <span class="s1">&#39;center_z&#39;</span><span class="p">]</span>
                                                                <span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
    
    <span class="c1"># Generate UMAP of X as alternative visualization</span>
    <span class="c1"># already cirro-compatible as it&#39;s stored in obsm[&#39;X_umap&#39;]</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">pca</span><span class="p">(</span><span class="n">cell_by_gene_cirro</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">pp</span><span class="o">.</span><span class="n">neighbors</span><span class="p">(</span><span class="n">cell_by_gene_cirro</span><span class="p">)</span>
    <span class="n">sc</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">umap</span><span class="p">(</span><span class="n">cell_by_gene_cirro</span><span class="p">)</span>
    <span class="c1"># Optional future update: UMAP of all layers (will run much slower)</span>
    <span class="c1"># for layer in cell_by_gene.layers.keys():</span>
    <span class="c1">#     sc.pp.pca(cell_by_gene, layer=layer)</span>
    <span class="c1">#     sc.pp.neighbors(cell_by_gene, layer=layer)</span>
    <span class="c1">#     sc.tl.umap(cell_by_gene, layer=layer)</span>

    <span class="k">return</span> <span class="n">cell_by_gene_cirro</span></div>


</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Spots-in-Spaaaaaace!</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Allen Spatial Analysis Working Group.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>