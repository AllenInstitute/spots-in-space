<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sis.hpc &#8212; Spots-in-Spaaaaaace! 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for sis.hpc</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
<span class="kn">import</span> <span class="nn">subprocess</span><span class="o">,</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">re</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">atexit</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<div class="viewcode-block" id="run_slurm_func">
<a class="viewcode-back" href="../../sis.html#sis.hpc.run_slurm_func">[docs]</a>
<span class="k">def</span> <span class="nf">run_slurm_func</span><span class="p">(</span><span class="n">run_spec</span><span class="p">,</span> <span class="n">conda_env</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a function on SLURM.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    run_spec : tuple | dict</span>
<span class="sd">        Either a tuple containing (func, args, kwargs) to be called in SLURM jobs, or a dict</span>
<span class="sd">        where the keys are array job IDs and the values are (func, args, kwargs) tuples.</span>
<span class="sd">    conda_env : str</span>
<span class="sd">        Conda envronment from which to run *func*</span>
<span class="sd">    **kwds</span>
<span class="sd">        All other keyword arguments are passed to run_slurm().</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkl_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;job_path&#39;</span><span class="p">],</span> <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;job_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_func.pkl&#39;</span><span class="p">)</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">run_spec</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">pkl_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">))</span>

    <span class="k">assert</span> <span class="s1">&#39;command&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span>
    <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;command&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;conda run -p </span><span class="si">{</span><span class="n">conda_env</span><span class="si">}</span><span class="s1"> python -m sis.hpc </span><span class="si">{</span><span class="n">pkl_file</span><span class="si">}</span><span class="s1"> $SLURM_ARRAY_TASK_ID&#39;</span>

    <span class="k">return</span> <span class="n">run_slurm</span><span class="p">(</span><span class="o">**</span><span class="n">kwds</span><span class="p">)</span></div>



<div class="viewcode-block" id="hpc_worker">
<a class="viewcode-back" href="../../sis.html#sis.hpc.hpc_worker">[docs]</a>
<span class="k">def</span> <span class="nf">hpc_worker</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Invoked when running `python -m sis.hpc`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pkl_file</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">run_specs</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">pkl_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run_specs</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">array_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Started HPC worker </span><span class="si">{</span><span class="n">array_id</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Call spec file: </span><span class="si">{</span><span class="n">pkl_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">run_specs</span><span class="p">[</span><span class="n">array_id</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Started </span><span class="si">{</span><span class="n">sys</span><span class="o">.</span><span class="n">executable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Call spec file: </span><span class="si">{</span><span class="n">pkl_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span> <span class="o">=</span> <span class="n">run_specs</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invoking callback: </span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-----------------------------&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;HPC worker complete. Callback returned:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span></div>



<div class="viewcode-block" id="run_slurm">
<a class="viewcode-back" href="../../sis.html#sis.hpc.run_slurm">[docs]</a>
<span class="k">def</span> <span class="nf">run_slurm</span><span class="p">(</span><span class="o">*</span><span class="p">,</span>
    <span class="n">hpc_host</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">job_path</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">partition</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">job_name</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">nodes</span><span class="p">:</span><span class="nb">int</span><span class="p">,</span>
    <span class="n">ntasks</span><span class="p">:</span><span class="nb">int</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">array</span><span class="p">:</span><span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mincpus</span><span class="p">:</span><span class="nb">int</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
    <span class="n">gpus_per_node</span><span class="p">:</span><span class="nb">int</span><span class="o">|</span><span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">mem</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">time</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">command</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">mail_user</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span>
    <span class="n">mail_type</span><span class="p">:</span><span class="nb">str</span><span class="o">=</span><span class="s1">&#39;END,FAIL&#39;</span><span class="p">,</span>
    <span class="n">output</span><span class="p">:</span><span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">error</span><span class="p">:</span><span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">job_file</span><span class="p">:</span><span class="nb">str</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Call sbatch (locally or over ssh) and return a SlurmJob instance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    hpc_host : str</span>
<span class="sd">        Host to call sbatch from. If not &#39;localhost&#39;, then commands are executed</span>
<span class="sd">        on *hpc_host* via ssh.</span>
<span class="sd">    job_path : str</span>
<span class="sd">        Location to write slurm script file and output/error logs.</span>
<span class="sd">        Must be accessible from *hpc_host*.</span>
<span class="sd">    partition : str</span>
<span class="sd">        SLURM partition to allocate job</span>
<span class="sd">    job_name : str</span>
<span class="sd">        SLURM job name. This is also used to set default file names for the sbatch script,</span>
<span class="sd">        output log, and error log.</span>
<span class="sd">    nodes : int</span>
<span class="sd">        Number of nodes to request</span>
<span class="sd">    ntasks : int</span>
<span class="sd">        Number of tasks to launch per job.</span>
<span class="sd">        (Use multiple tasks when all must be scheduled to start simultaneously)</span>
<span class="sd">    array : str | None</span>
<span class="sd">        Use array=&quot;A-B&quot; where A and B are the first and last index to start multiple,</span>
<span class="sd">        independent jobs. The output/error file names may include &quot;%a&quot; to reference the</span>
<span class="sd">        array index, and the command may use $SLURM_ARRAY_TASK_ID.</span>
<span class="sd">    mincpus : int | None</span>
<span class="sd">        Minimum CPUs per node</span>
<span class="sd">    gpus_per_node : int | str | None</span>
<span class="sd">        GPUs per node</span>
<span class="sd">    mem : str</span>
<span class="sd">        Maximum memory to allocate per job (e.g. &#39;100G&#39;)</span>
<span class="sd">    time : str</span>
<span class="sd">        Maximum job time (e.g. &quot;4:00:00&quot;)</span>
<span class="sd">    command : str</span>
<span class="sd">        Command to run per job (e.g. &quot;srun mycommand $SLURM_ARRAY_TASK_ID&quot;)</span>
<span class="sd">    mail_user : str | None</span>
<span class="sd">        Optional email address to notify upon completion</span>
<span class="sd">    mail_type : str</span>
<span class="sd">        Events on which to send email (default=&#39;END,FAIL&#39;)</span>
<span class="sd">    output : str | None</span>
<span class="sd">        Optional location of file to store command output (default is in job_path</span>
<span class="sd">        with automatically chosen name)</span>
<span class="sd">    error : str | None</span>
<span class="sd">        Optional location of file to store error output (default is in job_path</span>
<span class="sd">        with automatically chosen name)</span>
<span class="sd">    job_file : str | None</span>
<span class="sd">        Optional location to store sbatch script (default is in job_path</span>
<span class="sd">        with automatically chosen name)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">array</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">filename_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_path</span><span class="p">,</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s2">&quot;_%j&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">filename_prefix</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_path</span><span class="p">,</span> <span class="n">job_name</span> <span class="o">+</span> <span class="s2">&quot;_%A_</span><span class="si">%a</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">output</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">filename_prefix</span> <span class="o">+</span> <span class="s2">&quot;_output.log&quot;</span>
    <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">error</span> <span class="o">=</span> <span class="n">filename_prefix</span> <span class="o">+</span> <span class="s2">&quot;_error.log&quot;</span>
    <span class="k">if</span> <span class="n">job_file</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">job_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">job_path</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">job_name</span><span class="si">}</span><span class="s2">.sbatch.sh&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">mail_user</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mail_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">arglist</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s1">&#39;partition&#39;</span><span class="p">,</span> <span class="s1">&#39;job_name&#39;</span><span class="p">,</span> <span class="s1">&#39;nodes&#39;</span><span class="p">,</span> <span class="s1">&#39;ntasks&#39;</span><span class="p">,</span> <span class="s1">&#39;array&#39;</span><span class="p">,</span> <span class="s1">&#39;mincpus&#39;</span><span class="p">,</span> <span class="s1">&#39;mem&#39;</span><span class="p">,</span>
        <span class="s1">&#39;gpus_per_node&#39;</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="s1">&#39;mail_user&#39;</span><span class="p">,</span> <span class="s1">&#39;mail_type&#39;</span><span class="p">,</span> <span class="s1">&#39;output&#39;</span><span class="p">,</span> <span class="s1">&#39;error&#39;</span><span class="p">,</span>
    <span class="p">]</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">script</span> <span class="o">=</span> <span class="s2">&quot;#!/bin/bash&quot;</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">arglist</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="nb">locals</span><span class="p">()[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">script</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">#SBATCH --</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">=</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">script</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">command</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">job_file</span><span class="p">)):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">job_file</span><span class="p">))</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">job_file</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>

    <span class="n">sbatch_output</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">hpc_host</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;sbatch&#39;</span><span class="p">,</span> <span class="n">job_file</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;array&#39;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SlurmJob</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="o">=</span><span class="n">sbatch_output</span><span class="p">,</span> <span class="n">job_file</span><span class="o">=</span><span class="n">job_file</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">hpc_host</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">SlurmJobArray</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="o">=</span><span class="n">sbatch_output</span><span class="p">,</span> <span class="n">job_file</span><span class="o">=</span><span class="n">job_file</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="n">hpc_host</span><span class="p">)</span></div>



<div class="viewcode-block" id="SlurmJob">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJob">[docs]</a>
<span class="k">class</span> <span class="nc">SlurmJob</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="p">,</span> <span class="n">job_file</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">array_id</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">job_array</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sbatch_output</span> <span class="o">=</span> <span class="n">sbatch_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">array_id</span> <span class="o">=</span> <span class="n">array_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_array</span> <span class="o">=</span> <span class="n">job_array</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_file</span> <span class="o">=</span> <span class="n">job_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">localtime</span><span class="p">()</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Submitted batch job (\d+)&#39;</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_job_id</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">array_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_job_id</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_job_id</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array_id</span><span class="p">)</span>

<div class="viewcode-block" id="SlurmJob.state">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJob.state">[docs]</a>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the state code for this job, or a dictionary of state codes for array jobs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">sacct</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">job_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">base_job_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">JobState</span><span class="p">(</span><span class="n">state</span><span class="o">=</span><span class="n">table</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;State&#39;</span><span class="p">:</span> <span class="s1">&#39;NO_INFO&#39;</span><span class="p">})[</span><span class="s1">&#39;State&#39;</span><span class="p">])</span></div>


<div class="viewcode-block" id="SlurmJob.is_done">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJob.is_done">[docs]</a>
    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">()</span><span class="o">.</span><span class="n">is_done</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename_replacement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">error_file</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename_replacement</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="s1">&#39;error&#39;</span><span class="p">])</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">output</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">output_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">error</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">error_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_filename_replacement</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">):</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;%j&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;%A&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_job_id</span><span class="p">)</span>
        <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;</span><span class="si">%a</span><span class="s1">&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">array_id</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">fn</span>

<div class="viewcode-block" id="SlurmJob.cancel">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJob.cancel">[docs]</a>
    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;scancel&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)])</span></div>
</div>



<div class="viewcode-block" id="SlurmJobArray">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJobArray">[docs]</a>
<span class="k">class</span> <span class="nc">SlurmJobArray</span><span class="p">(</span><span class="n">SlurmJob</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="p">,</span> <span class="n">job_file</span><span class="p">,</span> <span class="n">host</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sbatch_output</span> <span class="o">=</span> <span class="n">sbatch_output</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_fie</span> <span class="o">=</span> <span class="n">job_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">host</span> <span class="o">=</span> <span class="n">host</span>

        <span class="n">start</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">stop</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="s1">&#39;array&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="p">)</span>

        <span class="n">m</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Submitted batch job (\d+)&#39;</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_id</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">groups</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">start</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">stop</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">SlurmJob</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">sbatch_output</span><span class="p">,</span> <span class="n">job_file</span><span class="p">,</span> <span class="n">host</span><span class="p">,</span> <span class="n">array_id</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">job_array</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">job</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[</span><span class="n">item</span><span class="p">]</span>

<div class="viewcode-block" id="SlurmJobArray.state">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJobArray.state">[docs]</a>
    <span class="k">def</span> <span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">job</span><span class="o">.</span><span class="n">job_id</span><span class="p">:</span><span class="n">job</span><span class="o">.</span><span class="n">state</span><span class="p">()</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">}</span></div>


<div class="viewcode-block" id="SlurmJobArray.is_done">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJobArray.is_done">[docs]</a>
    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">([</span><span class="n">job</span><span class="o">.</span><span class="n">is_done</span><span class="p">()</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">])</span></div>


<div class="viewcode-block" id="SlurmJobArray.cancel">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJobArray.cancel">[docs]</a>
    <span class="k">def</span> <span class="nf">cancel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;scancel&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_id</span><span class="p">)])</span></div>


<div class="viewcode-block" id="SlurmJobArray.finished_jobs">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJobArray.finished_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">finished_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="k">if</span> <span class="n">job</span><span class="o">.</span><span class="n">is_done</span><span class="p">()]</span></div>


<div class="viewcode-block" id="SlurmJobArray.unfinished_jobs">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJobArray.unfinished_jobs">[docs]</a>
    <span class="k">def</span> <span class="nf">unfinished_jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">job</span> <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">job</span><span class="o">.</span><span class="n">is_done</span><span class="p">()]</span></div>


<div class="viewcode-block" id="SlurmJobArray.wait_iter">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJobArray.wait_iter">[docs]</a>
    <span class="k">def</span> <span class="nf">wait_iter</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Iterator that returns jobs as they finish</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobs</span><span class="p">[:]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">jobs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">jobs</span><span class="p">[:]:</span>
                <span class="k">if</span> <span class="n">j</span><span class="o">.</span><span class="n">is_done</span><span class="p">():</span>
                    <span class="n">jobs</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
                    <span class="k">yield</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span></div>


<div class="viewcode-block" id="SlurmJobArray.state_counts">
<a class="viewcode-back" href="../../sis.html#sis.hpc.SlurmJobArray.state_counts">[docs]</a>
    <span class="k">def</span> <span class="nf">state_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">([</span><span class="n">s</span><span class="o">.</span><span class="n">state_code</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">()],</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span></div>
</div>



<div class="viewcode-block" id="JobState">
<a class="viewcode-back" href="../../sis.html#sis.hpc.JobState">[docs]</a>
<span class="k">class</span> <span class="nc">JobState</span><span class="p">:</span>

    <span class="n">state_codes</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;BF&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;BOOT_FAIL&#39;</span><span class="p">,</span>       <span class="s1">&#39;Job terminated due to launch failure, typically due to a hardware failure (e.g. unable to boot the node or block and the job can not be requeued).&#39;</span><span class="p">),</span>
        <span class="s1">&#39;CA&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;CANCELLED&#39;</span><span class="p">,</span>       <span class="s1">&#39;Job was explicitly cancelled by the user or system administrator.  The job may or may not have been initiated.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;CD&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;COMPLETED&#39;</span><span class="p">,</span>       <span class="s1">&#39;Job has terminated all processes on all nodes with an exit code of zero.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;CF&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;CONFIGURING&#39;</span><span class="p">,</span>     <span class="s1">&#39;Job has been allocated resources, but are waiting for them to become ready for use (e.g. booting).&#39;</span><span class="p">),</span>
        <span class="s1">&#39;CG&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;COMPLETING&#39;</span><span class="p">,</span>      <span class="s1">&#39;Job is in the process of completing. Some processes on some nodes may still be active.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;DL&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;DEADLINE&#39;</span><span class="p">,</span>        <span class="s1">&#39;Job terminated on deadline.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;F&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="s1">&#39;FAILED&#39;</span><span class="p">,</span>          <span class="s1">&#39;Job terminated with non-zero exit code or other failure condition.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;NF&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;NODE_FAIL&#39;</span><span class="p">,</span>       <span class="s1">&#39;Job terminated due to failure of one or more allocated nodes.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;OOM&#39;</span><span class="p">:</span> <span class="p">(</span><span class="s1">&#39;OUT_OF_MEMORY&#39;</span><span class="p">,</span>   <span class="s1">&#39;Job experienced out of memory error.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;PD&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;PENDING&#39;</span><span class="p">,</span>         <span class="s1">&#39;Job is awaiting resource allocation.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;PR&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;PREEMPTED&#39;</span><span class="p">,</span>       <span class="s1">&#39;Job terminated due to preemption.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;R&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="s1">&#39;RUNNING&#39;</span><span class="p">,</span>         <span class="s1">&#39;Job currently has an allocation.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;RD&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;RESV_DEL_HOLD&#39;</span><span class="p">,</span>   <span class="s1">&#39;Job is being held after requested reservation was deleted.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;RF&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;REQUEUE_FED&#39;</span><span class="p">,</span>     <span class="s1">&#39;Job is being requeued by a federation.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;RH&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;REQUEUE_HOLD&#39;</span><span class="p">,</span>    <span class="s1">&#39;Held job is being requeued.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;RQ&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;REQUEUED&#39;</span><span class="p">,</span>        <span class="s1">&#39;Completing job is being requeued.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;RS&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;RESIZING&#39;</span><span class="p">,</span>        <span class="s1">&#39;Job is about to change size.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;RV&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;REVOKED&#39;</span><span class="p">,</span>         <span class="s1">&#39;Sibling was removed from cluster due to other cluster starting the job.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;SI&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;SIGNALING&#39;</span><span class="p">,</span>       <span class="s1">&#39;Job is being signaled.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;SE&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;SPECIAL_EXIT&#39;</span><span class="p">,</span>    <span class="s1">&#39;The job was requeued in a special state. This state can be set by users, typically in EpilogSlurmctld, if the job has terminated with a particular exit value.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;SO&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;STAGE_OUT&#39;</span><span class="p">,</span>       <span class="s1">&#39;Job is staging out files.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;ST&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;STOPPED&#39;</span><span class="p">,</span>         <span class="s1">&#39;Job has an allocation, but execution has been stopped with SIGSTOP signal.  CPUS have been retained by this job.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;S&#39;</span><span class="p">:</span>   <span class="p">(</span><span class="s1">&#39;SUSPENDED&#39;</span><span class="p">,</span>       <span class="s1">&#39;Job has an allocation, but execution has been suspended and CPUs have been released for other jobs.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;TO&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;TIMEOUT&#39;</span><span class="p">,</span>         <span class="s1">&#39;Job terminated upon reaching its time limit.&#39;</span><span class="p">),</span>
        <span class="s1">&#39;NO&#39;</span><span class="p">:</span>  <span class="p">(</span><span class="s1">&#39;NO_INFO&#39;</span><span class="p">,</span>         <span class="s1">&#39;Squeue returned no information about the requested job ID&#39;</span><span class="p">),</span>
    <span class="p">}</span>

    <span class="n">state_descriptions</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state_codes</span><span class="o">.</span><span class="n">values</span><span class="p">()}</span>
    <span class="n">state_to_code</span> <span class="o">=</span> <span class="p">{</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span> <span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">state_codes</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_code</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Check to make sure that state and state code don&#39;t conflict    </span>
        <span class="k">if</span> <span class="n">state</span> <span class="ow">and</span> <span class="n">state_code</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">state_code</span> <span class="o">!=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">state_to_code</span><span class="p">[</span><span class="n">state</span><span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;state_code and state contain conflicting values&#39;</span><span class="p">)</span>
                
        <span class="k">if</span> <span class="n">state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_code</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">state_to_code</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">state_descriptions</span><span class="p">[</span><span class="n">state</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_code</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;BF&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;CD&#39;</span><span class="p">,</span> <span class="s1">&#39;DL&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;NF&#39;</span><span class="p">,</span> <span class="s1">&#39;OOM&#39;</span><span class="p">,</span> <span class="s1">&#39;PR&#39;</span><span class="p">,</span> <span class="s1">&#39;TO&#39;</span><span class="p">,</span> <span class="s1">&#39;NO&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">state_code</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state_code</span> <span class="o">=</span> <span class="n">state_code</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span> <span class="o">=</span> <span class="n">JobState</span><span class="o">.</span><span class="n">state_codes</span><span class="p">[</span><span class="n">state_code</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span> <span class="o">=</span> <span class="n">state_code</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;BF&#39;</span><span class="p">,</span> <span class="s1">&#39;CA&#39;</span><span class="p">,</span> <span class="s1">&#39;CD&#39;</span><span class="p">,</span> <span class="s1">&#39;DL&#39;</span><span class="p">,</span> <span class="s1">&#39;F&#39;</span><span class="p">,</span> <span class="s1">&#39;NF&#39;</span><span class="p">,</span> <span class="s1">&#39;OOM&#39;</span><span class="p">,</span> <span class="s1">&#39;PR&#39;</span><span class="p">,</span> <span class="s1">&#39;TO&#39;</span><span class="p">,</span> <span class="s1">&#39;NO&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Must input one of state_code or state&#39;</span><span class="p">)</span>
        
        
    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;JobState </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">&gt;&quot;</span></div>

    

<span class="n">_last_squeue</span> <span class="o">=</span> <span class="p">{}</span>
<div class="viewcode-block" id="squeue">
<a class="viewcode-back" href="../../sis.html#sis.hpc.squeue">[docs]</a>
<span class="k">def</span> <span class="nf">squeue</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">cache_duration</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_last_squeue</span>
    <span class="c1"># 10-second cache to rate limit squeue calls</span>
    <span class="n">last_time</span><span class="p">,</span> <span class="n">last_state</span> <span class="o">=</span> <span class="n">_last_squeue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">last_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last_time</span> <span class="o">&gt;</span> <span class="n">cache_duration</span><span class="p">:</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;squeue&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;--job=</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">])</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokens</span><span class="p">[:</span><span class="mi">7</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">7</span><span class="p">:])]</span>  <span class="c1"># NODELIST(REASON) column may contain spaces</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">field</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">)}</span>
            <span class="n">table</span><span class="p">[</span><span class="n">fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;JOBID&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="n">_last_squeue</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">last_state</span>
    <span class="k">return</span> <span class="n">table</span></div>



<span class="n">_last_sacct</span> <span class="o">=</span> <span class="p">{}</span>
<div class="viewcode-block" id="sacct">
<a class="viewcode-back" href="../../sis.html#sis.hpc.sacct">[docs]</a>
<span class="k">def</span> <span class="nf">sacct</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">cache_duration</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_last_sacct</span>
    <span class="c1"># 10-second cache to rate limit sacct calls</span>
    <span class="n">last_time</span><span class="p">,</span> <span class="n">last_state</span> <span class="o">=</span> <span class="n">_last_sacct</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
    <span class="n">now</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">last_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">now</span> <span class="o">-</span> <span class="n">last_time</span> <span class="o">&gt;</span> <span class="n">cache_duration</span><span class="p">:</span>
        <span class="n">stat</span> <span class="o">=</span> <span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;sacct&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;--job=</span><span class="si">{</span><span class="n">job_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;--format=JobID%20,State%20&#39;</span><span class="p">,</span> <span class="s1">&#39;-X&#39;</span><span class="p">])</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="n">stat</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="n">table</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">:]:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tokens</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\s+&#39;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="n">fields</span> <span class="o">=</span> <span class="p">{</span><span class="n">cols</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span><span class="n">field</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">field</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tokens</span><span class="p">)}</span>
            <span class="n">table</span><span class="p">[</span><span class="n">fields</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;JobID&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">fields</span>
        <span class="n">_last_sacct</span><span class="p">[</span><span class="n">job_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">now</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">table</span> <span class="o">=</span> <span class="n">last_state</span>
    <span class="k">return</span> <span class="n">table</span></div>



<span class="n">ssh_connections</span> <span class="o">=</span> <span class="p">{}</span>

<div class="viewcode-block" id="run">
<a class="viewcode-back" href="../../sis.html#sis.hpc.run">[docs]</a>
<span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">host</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span> <span class="n">cmd</span><span class="p">:</span><span class="nb">list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run a command on any host. If the host is other than localhost,</span>
<span class="sd">    then the command is run over ssh.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">ssh_connections</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">host</span> <span class="o">!=</span> <span class="s1">&#39;localhost&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">host</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ssh_connections</span><span class="p">:</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s1">&#39;ssh&#39;</span><span class="p">,</span> <span class="s1">&#39;-NM&#39;</span><span class="p">,</span> <span class="n">host</span><span class="p">])</span>
            <span class="n">ssh_connections</span><span class="p">[</span><span class="n">host</span><span class="p">]</span> <span class="o">=</span> <span class="n">conn</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ssh&#39;</span><span class="p">,</span> <span class="n">host</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmd</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">check_output</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">STDOUT</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">()</span>
    <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">exc</span><span class="o">.</span><span class="n">output</span><span class="p">)</span>
        <span class="k">raise</span></div>


<div class="viewcode-block" id="close_ssh_connections">
<a class="viewcode-back" href="../../sis.html#sis.hpc.close_ssh_connections">[docs]</a>
<span class="k">def</span> <span class="nf">close_ssh_connections</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">ssh_connections</span>
    <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="n">ssh_connections</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>
    <span class="n">ssh_connections</span> <span class="o">=</span> <span class="p">{}</span></div>


<span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">close_ssh_connections</span><span class="p">)</span>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">hpc_worker</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Spots-in-Spaaaaaace!</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Allen Spatial Analysis Working Group.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>