<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>sis.spatial_dataset &#8212; Spots-in-Spaaaaaace! 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for sis.spatial_dataset</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>

<span class="c1">## Class SpatialDataset to organize spatial datasets from variety of platforms</span>
<span class="c1">## includes subclasses for each platform to encompass data processing steps</span>
<span class="c1">## use to version data processing</span>
<span class="c1">## These classes can just store pointers to segmentation, mapping, etc and not copies of the data itself. This will allow the tools already</span>
<span class="c1">## built to still access those files without having to load the whole class which could get burdensome</span>
<span class="c1">## utilizes new Allen Services for data grabbing </span>
<span class="c1">## spatial_config.yml to store datapaths and other configurable properties</span>


<span class="kn">from</span> <span class="nn">sis.celltype_mapping</span> <span class="kn">import</span> <span class="n">ScrattchMapping</span><span class="p">,</span> <span class="n">CellTypeMapping</span>
<span class="kn">from</span> <span class="nn">sis.hpc</span> <span class="kn">import</span> <span class="n">run_slurm_func</span>
<span class="kn">from</span> <span class="nn">sis.qc</span> <span class="kn">import</span> <span class="n">run_doublet_detection</span><span class="p">,</span> <span class="n">calc_n_transcripts</span><span class="p">,</span> <span class="n">calc_n_genes</span><span class="p">,</span> <span class="n">calc_n_blanks</span>
<span class="kn">from</span> <span class="nn">sis.segmentation</span> <span class="kn">import</span> <span class="n">MerscopeSegmentationRun</span>
<span class="kn">from</span> <span class="nn">sis.spot_table</span> <span class="kn">import</span> <span class="n">SpotTable</span>
<span class="kn">from</span> <span class="nn">sis.util</span> <span class="kn">import</span> <span class="n">load_config</span>
<span class="kn">import</span> <span class="nn">anndata</span> <span class="k">as</span> <span class="nn">ad</span>
<span class="kn">import</span> <span class="nn">os</span><span class="o">,</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">datetime</span><span class="o">,</span> <span class="nn">glob</span><span class="o">,</span> <span class="nn">pickle</span><span class="o">,</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">from</span> <span class="nn">abc</span> <span class="kn">import</span> <span class="n">abstractmethod</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pickle</span> <span class="k">as</span> <span class="nn">pkl</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">tqdm.autonotebook</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">redirect_stdout</span>
<span class="kn">from</span> <span class="nn">.optional_import</span> <span class="kn">import</span> <span class="n">optional_import</span>

<span class="n">widgets</span> <span class="o">=</span> <span class="n">optional_import</span><span class="p">(</span><span class="s1">&#39;ipywidgets&#39;</span><span class="p">)</span>
<span class="n">interact_manual</span> <span class="o">=</span> <span class="n">optional_import</span><span class="p">(</span><span class="s1">&#39;ipywidgets&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="s1">&#39;interact_manual&#39;</span><span class="p">)</span>


<span class="c1">## Allen Services</span>
<span class="n">pts_schema</span> <span class="o">=</span> <span class="n">optional_import</span><span class="p">(</span><span class="s1">&#39;allen_services_api.pts.schema.pts_schema&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span> <span class="s1">&#39;pts_schema&#39;</span><span class="p">)</span>
<span class="n">DatsClient</span> <span class="o">=</span> <span class="n">optional_import</span><span class="p">(</span><span class="s1">&#39;allen_services_api.dats.client.dats_client&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span>  <span class="s2">&quot;DatsClient&quot;</span><span class="p">)</span>
<span class="n">PtsClient</span> <span class="o">=</span> <span class="n">optional_import</span><span class="p">(</span><span class="s1">&#39;allen_services_api.pts.client.pts_client&#39;</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span>  <span class="s2">&quot;PtsClient&quot;</span><span class="p">)</span>
<span class="n">BersClient</span> <span class="o">=</span> <span class="n">optional_import</span><span class="p">(</span> <span class="s1">&#39;allen_services_api.bers.client.bers_client&#39;</span><span class="p">,</span> <span class="n">names</span> <span class="o">=</span>  <span class="s2">&quot;BersClient&quot;</span><span class="p">)</span>


<span class="n">SPATIALDATASET_VERSION</span> <span class="o">=</span> <span class="mi">2</span>


<div class="viewcode-block" id="SpatialDataset">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.SpatialDataset">[docs]</a>
<span class="k">class</span> <span class="nc">SpatialDataset</span><span class="p">:</span>
    <span class="c1"># wrapper class</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">barcode</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">barcode</span> <span class="o">=</span> <span class="n">barcode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">SPATIALDATASET_VERSION</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>
        
<div class="viewcode-block" id="SpatialDataset.load_from_barcode">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.SpatialDataset.load_from_barcode">[docs]</a>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_from_barcode</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">barcode</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">dataset_type</span><span class="p">:</span> <span class="s1">&#39;SpatialDataset&#39;</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;spatial_dataset&#39;</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">dataset_type</span> <span class="o">==</span> <span class="n">MERSCOPESection</span><span class="p">:</span>
            <span class="n">data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;merscope_save_path&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">barcode</span><span class="p">),</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dataset_type</span> <span class="o">==</span> <span class="n">StereoSeqSection</span><span class="p">:</span>
            <span class="n">data_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;stereoseq_save_path&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">barcode</span><span class="p">),</span> <span class="n">file_name</span><span class="p">)</span>
        <span class="c1"># other config paths would be added here as they come about</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">data_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SpatialDataset </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1"> does not exist&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">data_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">pkl</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
            <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">_convert_str_to_paths</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SpatialDataset </span><span class="si">{</span><span class="n">data_path</span><span class="si">}</span><span class="s1"> loaded...&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">version</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Warning: SpatialDataset version </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">version</span><span class="si">}</span><span class="s1"> does not match current version </span><span class="si">{</span><span class="n">version</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">dataset</span></div>


<div class="viewcode-block" id="SpatialDataset.save_dataset">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.SpatialDataset.save_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">save_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">:</span> <span class="nb">str</span><span class="o">=</span><span class="s1">&#39;spatial_dataset&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_paths_to_str</span><span class="p">()</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>
        <span class="n">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">),</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">pkl</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
        <span class="n">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># convert back to paths to continue using the object (bit hacky)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convert_str_to_paths</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">_get_path_attrs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path_attrs</span> <span class="o">=</span> <span class="p">[</span><span class="n">k</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_path&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_file&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_cache&#39;</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">path_attrs</span>

    <span class="k">def</span> <span class="nf">_convert_paths_to_str</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_attrs</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">path_attrs</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">Path</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_convert_str_to_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">path_attrs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_path_attrs</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">path_attrs</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
            <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">Path</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
 
<div class="viewcode-block" id="SpatialDataset.get_analysis_status">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.SpatialDataset.get_analysis_status">[docs]</a>
    <span class="k">def</span> <span class="nf">get_analysis_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># check for segmentation and mapping files</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;corr_to_bulk&#39;</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Correlation to bulk already calculated: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">corr_to_bulk</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Correlation to bulk not calculated&#39;</span><span class="p">)</span>

        <span class="n">seg_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_segmentation_status</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">seg_status</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;No segmentations available in </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Segmentation timestamps: </span><span class="se">\t</span><span class="s1"> Segmentation info&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">seg_status</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s1">: </span><span class="se">\t</span><span class="s1"> </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="n">mappings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mappings</span><span class="p">(</span><span class="n">print_output</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mappings</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No mappings found&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Mapping timestamps: </span><span class="se">\t</span><span class="s1"> Mapping info&#39;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">ts</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">mappings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s1">: </span><span class="se">\t</span><span class="s1"> </span><span class="si">{</span><span class="n">info</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="SpatialDataset.check_segmentation_status">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.SpatialDataset.check_segmentation_status">[docs]</a>
    <span class="k">def</span> <span class="nf">check_segmentation_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Get all subdirectories in segmentation directory</span>
        <span class="c1"># Each should correspond to a segmentation run... unless there are</span>
        <span class="c1"># weird random folders that shouldn&#39;t be there...</span>
        <span class="n">segmentation_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span>
        <span class="n">seg_runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">segmentation_path</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg_runs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">seg_runs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">run_name</span> <span class="ow">in</span> <span class="n">seg_runs</span><span class="p">:</span>
                <span class="n">run_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">segmentation_path</span><span class="p">,</span> <span class="n">run_name</span><span class="p">)</span>
                <span class="n">final_output</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="s1">&#39;cell_by_gene.h5ad&#39;</span><span class="p">)</span>
                <span class="n">seg_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;finished&#39;</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">final_output</span><span class="p">)}</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">seg_config_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">run_path</span><span class="p">,</span> <span class="s1">&#39;seg_meta.json&#39;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">seg_config_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">seg_config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

                    <span class="n">seg_info</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">k</span><span class="p">:</span> <span class="n">seg_config</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;subrgn&#39;</span><span class="p">,</span> <span class="s1">&#39;seg_method&#39;</span><span class="p">,</span> <span class="s1">&#39;seg_opts&#39;</span><span class="p">]})</span>

                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">status</span><span class="p">[</span><span class="n">run_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">seg_info</span>

        <span class="k">return</span> <span class="n">status</span></div>


<div class="viewcode-block" id="SpatialDataset.get_mappings">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.SpatialDataset.get_mappings">[docs]</a>
    <span class="k">def</span> <span class="nf">get_mappings</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">print_output</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="n">mappings</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">mapping_dir</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;mapping_path&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">mapping_dir</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No mapping directory specified&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">mappings</span>
        <span class="n">mapping_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span>
        <span class="k">for</span> <span class="n">mapping</span> <span class="ow">in</span> <span class="n">mapping_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="n">ts</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">name</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="n">redirect_stdout</span><span class="p">(</span><span class="kc">None</span><span class="p">):</span>
                    <span class="n">meta</span> <span class="o">=</span> <span class="n">CellTypeMapping</span><span class="o">.</span><span class="n">load_from_timestamp</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="n">mapping_dir</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">meta_only</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">mappings</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">meta</span>
                <span class="k">if</span> <span class="n">print_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">meta</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">mappings</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">print_output</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s1">: None&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">mappings</span></div>

        
<div class="viewcode-block" id="SpatialDataset.spatial_corr_to_bulk">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.SpatialDataset.spatial_corr_to_bulk">[docs]</a>
    <span class="k">def</span> <span class="nf">spatial_corr_to_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">spot_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spot_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spot_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_spottable</span><span class="p">()</span>
        
        <span class="n">gene_ids</span><span class="p">,</span> <span class="n">total_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spot_table</span><span class="o">.</span><span class="n">gene_ids</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">genes</span> <span class="o">=</span> <span class="n">spot_table</span><span class="o">.</span><span class="n">map_gene_ids_to_names</span><span class="p">(</span><span class="n">gene_ids</span><span class="p">)</span>

        <span class="n">total_counts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;gene&#39;</span><span class="p">:</span> <span class="n">genes</span><span class="p">,</span> <span class="s1">&#39;spatial total counts&#39;</span><span class="p">:</span> <span class="n">total_counts</span><span class="p">})</span>
        <span class="n">total_counts</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="n">bulk_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;bulkseq_file&#39;</span><span class="p">])</span>
        <span class="n">bulk_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Gene Name&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">broad_region</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">broad_region</span> <span class="ow">in</span> <span class="n">bulk_data</span><span class="p">[</span><span class="s1">&#39;Broad Region&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">bulk_data_region</span> <span class="o">=</span> <span class="n">bulk_data</span><span class="p">[</span><span class="n">bulk_data</span><span class="p">[</span><span class="s1">&#39;Broad Region&#39;</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">broad_region</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Section Broad Region (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">broad_region</span><span class="si">}</span><span class="s1">) does not match any in bulk data reference (</span><span class="si">{</span><span class="n">bulk_data</span><span class="p">[</span><span class="s2">&quot;Broad Region&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="si">}</span><span class="s1">). </span><span class="se">\</span>
<span class="s1">                Using all reference bulk sequencing data for spatial correlation.&#39;</span><span class="p">)</span>
            <span class="n">bulk_data_region</span> <span class="o">=</span> <span class="n">bulk_data</span>
                  
        <span class="n">total_counts</span> <span class="o">=</span> <span class="n">total_counts</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">bulk_data_region</span><span class="p">[</span><span class="s1">&#39;FPKM&#39;</span><span class="p">],</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;inner&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">total_counts</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">total_counts</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39; log&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">total_counts</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

        <span class="n">total_counts_corr</span> <span class="o">=</span> <span class="n">total_counts</span><span class="o">.</span><span class="n">corr</span><span class="p">()[</span><span class="s1">&#39;spatial total counts log&#39;</span><span class="p">][</span><span class="s1">&#39;FPKM log&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_to_bulk</span> <span class="o">=</span> <span class="n">total_counts_corr</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">reduced_spots</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spot_table</span><span class="p">)</span><span class="o">/</span><span class="mi">100000</span><span class="p">))</span>
        <span class="n">spot_table</span><span class="p">[::</span><span class="n">reduced_spots</span><span class="p">]</span><span class="o">.</span><span class="n">scatter_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">total_counts</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;spatial total counts&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;FPKM&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Pearson corr: </span><span class="si">{</span><span class="n">total_counts_corr</span><span class="si">:</span><span class="s1">0.3f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save_fig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;correlation_to_bulk.png&#39;</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dataset</span><span class="p">()</span></div>


<div class="viewcode-block" id="SpatialDataset.show_gene_transcripts">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.SpatialDataset.show_gene_transcripts">[docs]</a>
    <span class="k">def</span> <span class="nf">show_gene_transcripts</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">genes</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">subregions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spot_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">spot_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spot_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_spottable</span><span class="p">()</span>
            
        <span class="n">fig_rows</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">subregions</span><span class="p">)</span> <span class="k">if</span> <span class="n">subregions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">1</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">fig_rows</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="o">*</span><span class="n">fig_rows</span><span class="p">))</span>
        
        <span class="n">gene_ids</span> <span class="o">=</span> <span class="n">spot_table</span><span class="o">.</span><span class="n">map_gene_names_to_ids</span><span class="p">(</span><span class="n">genes</span><span class="p">)</span>
        <span class="n">genes_table</span> <span class="o">=</span> <span class="n">spot_table</span><span class="o">.</span><span class="n">get_genes</span><span class="p">(</span><span class="n">gene_ids</span><span class="o">=</span><span class="n">gene_ids</span><span class="p">)</span>
        <span class="n">reduced_spots</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">spot_table</span><span class="p">)</span><span class="o">/</span><span class="mi">100000</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">fig_rows</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">spot_table</span><span class="p">[::</span><span class="n">reduced_spots</span><span class="p">]</span><span class="o">.</span><span class="n">scatter_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">spot_table</span><span class="o">.</span><span class="n">gene_names</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">genes_table</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;gene_names&#39;</span><span class="p">])</span>
            <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;gene_names&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;tab10&#39;</span><span class="p">,</span> <span class="n">hue_order</span><span class="o">=</span><span class="n">genes</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>  
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">subregion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">subregions</span><span class="p">):</span>
                <span class="n">spot_table</span><span class="p">[::</span><span class="n">reduced_spots</span><span class="p">]</span><span class="o">.</span><span class="n">scatter_plot</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">sub_table</span> <span class="o">=</span> <span class="n">genes_table</span><span class="o">.</span><span class="n">get_subregion</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="n">subregion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="o">=</span><span class="n">subregion</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">sub_table</span><span class="o">.</span><span class="n">plot_rect</span><span class="p">(</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">sub_table</span><span class="o">.</span><span class="n">gene_names</span>
                <span class="n">df</span> <span class="o">=</span> <span class="n">sub_table</span><span class="o">.</span><span class="n">dataframe</span><span class="p">(</span><span class="n">cols</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="s1">&#39;gene_names&#39;</span><span class="p">])</span>
                <span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">df</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;gene_names&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;tab10&#39;</span><span class="p">,</span> <span class="n">hue_order</span><span class="o">=</span><span class="n">genes</span><span class="p">)</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                
        <span class="k">if</span> <span class="n">save_fig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;marker_gene_transcripts.png&#39;</span><span class="p">))</span></div>


<div class="viewcode-block" id="SpatialDataset.view_mapping_results">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.SpatialDataset.view_mapping_results">[docs]</a>
    <span class="k">def</span> <span class="nf">view_mapping_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ct_map</span><span class="p">,</span> <span class="n">ct_level</span><span class="p">,</span> <span class="n">score_thresh</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ct_map</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ct_map</span> <span class="o">=</span> <span class="n">CellTypeMapping</span><span class="o">.</span><span class="n">load_from_timestamp</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">ct_map</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_map</span><span class="p">,</span> <span class="n">ScrattchMapping</span><span class="p">):</span>
            <span class="n">mapping_score_col</span> <span class="o">=</span> <span class="s1">&#39;score.Corr&#39;</span>
            <span class="n">col_labels</span> <span class="o">=</span> <span class="p">[</span><span class="n">prefix</span> <span class="o">+</span> <span class="s1">&#39;Corr&#39;</span> <span class="k">for</span> <span class="n">prefix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;taxonomy_info&#39;</span><span class="p">][</span><span class="n">ct_map</span><span class="o">.</span><span class="n">meta</span><span class="p">[</span><span class="s1">&#39;taxonomy_name&#39;</span><span class="p">]][</span><span class="s1">&#39;col_labels&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">mapping_score_col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">ct_map</span><span class="o">.</span><span class="n">load_scrattch_mapping_results</span><span class="p">()</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mapping_score_col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">score_thresh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">qc_pass</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">ct_map</span><span class="o">.</span><span class="n">qc_mapping</span><span class="p">(</span><span class="n">qc_params</span><span class="o">=</span><span class="p">{</span><span class="n">mapping_score_col</span><span class="p">:</span> <span class="n">score_thresh</span><span class="p">})</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">score_thresh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qc_pass</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">ct_map</span><span class="o">.</span><span class="n">run_directory</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;score_hist.png&#39;</span><span class="p">))</span>

        <span class="n">cls_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">col_labels</span> <span class="k">if</span> <span class="s1">&#39;class&#39;</span> <span class="ow">in</span> <span class="n">label</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ct_level_label</span> <span class="o">=</span> <span class="p">[</span><span class="n">label</span> <span class="k">for</span> <span class="n">label</span> <span class="ow">in</span> <span class="n">col_labels</span> <span class="k">if</span> <span class="n">ct_level</span> <span class="ow">in</span> <span class="n">label</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ct_level_label</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ct_level</span><span class="si">}</span><span class="s1"> does not have an obvious corresponding column in mapping output, check obs columns&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">ct_level_label</span> <span class="o">=</span> <span class="n">ct_level_label</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">groups</span><span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="bp">cls</span> <span class="ow">in</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cls_label</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">():</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">cls_label</span><span class="p">]</span><span class="o">==</span><span class="bp">cls</span><span class="p">][</span><span class="n">ct_level_label</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
            <span class="n">groups</span><span class="p">[</span><span class="bp">cls</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">plot_best_mapping_corr</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">ct_level_label</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">qc_pass</span><span class="o">=</span><span class="n">qc_pass</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;scale&#39;</span><span class="p">:</span> <span class="s1">&#39;width&#39;</span><span class="p">})</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">ct_map</span><span class="o">.</span><span class="n">run_directory</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;score_corr_</span><span class="si">{</span><span class="n">ct_level</span><span class="si">}</span><span class="s1">.png&#39;</span><span class="p">))</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">plot_best_mapping</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">ct_level_label</span><span class="p">,</span> <span class="n">groups</span><span class="o">=</span><span class="n">groups</span><span class="p">,</span> <span class="n">qc_pass</span><span class="o">=</span><span class="n">qc_pass</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;s&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">})</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">ct_map</span><span class="o">.</span><span class="n">run_directory</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">ct_level</span><span class="si">}</span><span class="s1">_spatial_map.png&#39;</span><span class="p">))</span></div>
</div>


<div class="viewcode-block" id="MERSCOPESection">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection">[docs]</a>
<span class="k">class</span> <span class="nc">MERSCOPESection</span><span class="p">(</span><span class="n">SpatialDataset</span><span class="p">):</span>


    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">barcode</span><span class="p">):</span>
        <span class="n">pts_qc_filt</span> <span class="o">=</span> <span class="n">pts_schema</span><span class="o">.</span><span class="n">MetadataFilterInput</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">pts_schema</span><span class="o">.</span><span class="n">DataTypeFilterInput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pts_schema</span><span class="o">.</span><span class="n">StringOperationFilterInput</span><span class="p">(</span><span class="n">eq</span><span class="o">=</span><span class="s2">&quot;QCMetadata&quot;</span><span class="p">)))</span>
        <span class="n">pts_request_filt</span> <span class="o">=</span> <span class="n">pts_schema</span><span class="o">.</span><span class="n">MetadataFilterInput</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="n">pts_schema</span><span class="o">.</span><span class="n">DataTypeFilterInput</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">pts_schema</span><span class="o">.</span><span class="n">StringOperationFilterInput</span><span class="p">(</span><span class="n">eq</span><span class="o">=</span><span class="s2">&quot;MerscopeImagingRequestMetadata&quot;</span><span class="p">)))</span>

        <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;merscope_save_path&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">barcode</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;spatial_dataset&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SpatialDataset already exists and will be loaded. If you want to reprocess this dataset delete the file and start over&#39;</span><span class="p">)</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">SpatialDataset</span><span class="o">.</span><span class="n">load_from_barcode</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span> <span class="n">MERSCOPESection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">cached</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_analysis_status</span><span class="p">()</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">SpatialDataset</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">barcode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mapping_dir&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mapping_dir&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;segmentation_dir&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;segmentation_dir&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">qc_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;qc_dir&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;qc_dir&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">qc_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">qc_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qc_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">broad_region</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_section_metadata</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_section_data_paths</span><span class="p">()</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">save_dataset</span><span class="p">()</span>

<div class="viewcode-block" id="MERSCOPESection.get_section_metadata">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.get_section_metadata">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">bers</span> <span class="o">=</span> <span class="n">BersClient</span><span class="p">()</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">PtsClient</span><span class="p">()</span>
        
        <span class="n">bers_spec</span> <span class="o">=</span> <span class="n">bers</span><span class="o">.</span><span class="n">get_specimen_by_lims2_id</span><span class="p">(</span><span class="n">lims2_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">barcode</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">bers_spec</span><span class="o">.</span><span class="n">specimen_type</span><span class="o">.</span><span class="n">label</span> <span class="o">==</span> <span class="s1">&#39;brain specimen section&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;not a LIMS2 Section specimen </span><span class="si">{</span><span class="n">bers_spec</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">bers_id</span> <span class="o">=</span> <span class="n">bers_spec</span><span class="o">.</span><span class="n">id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="n">bers_spec</span><span class="o">.</span><span class="n">species</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lims_specimen_name</span> <span class="o">=</span> <span class="n">bers_spec</span><span class="o">.</span><span class="n">name</span>
<span class="c1">#         self.roi  # this could come from multiple places, LIMS.structure, PTS_merscope_request_metadata_roi</span>
<span class="c1">#         self.hemisphere # may need to get this from slab parent if it is None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plane_of_section</span> <span class="o">=</span>  <span class="n">bers_spec</span><span class="o">.</span><span class="n">external_data</span><span class="o">.</span><span class="n">plane_of_section</span><span class="o">.</span><span class="n">name</span>
        
        <span class="n">spec_pts</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">get_processes_by_biological_entities</span><span class="p">(</span><span class="n">bers_spec</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">spec_pts</span><span class="o">.</span><span class="n">total_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="s1">&#39;MerscopeCoverslipProcessing&#39;</span> <span class="ow">in</span> <span class="n">spec_pts</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;not a MERSCOPE process&quot;</span>
        <span class="n">merscope_expt</span> <span class="o">=</span> <span class="n">spec_pts</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">qc_state</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">get_process_metadata</span><span class="p">(</span><span class="n">process_id</span> <span class="o">=</span> <span class="n">merscope_expt</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                                                 <span class="n">metadata_filter_input</span> <span class="o">=</span> <span class="n">MERSCOPESection</span><span class="o">.</span><span class="n">pts_qc_filt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;QC_State&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gene_panel</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">get_process_metadata</span><span class="p">(</span><span class="n">process_id</span> <span class="o">=</span> <span class="n">merscope_expt</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> 
                                                   <span class="n">metadata_filter_input</span> <span class="o">=</span> <span class="n">MERSCOPESection</span><span class="o">.</span><span class="n">pts_request_filt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;GenePanel&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">merscope_expt_pts_id</span> <span class="o">=</span> <span class="n">merscope_expt</span><span class="o">.</span><span class="n">id</span></div>

        
<span class="c1">#         self.section_thickness # not sure where this comes from?</span>
<span class="c1">#         self.z_coord # this will probably require some math and grabbing of parent z_coord - nothing currently in BERS </span>
<span class="c1">#         self.parent_z_coord</span>
        
    <span class="k">def</span> <span class="nf">_filter_dats_instances</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instances</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">instances</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">instance</span><span class="o">.</span><span class="n">storage</span><span class="p">[</span><span class="s1">&#39;storage_provider&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Isilon::POSIX&#39;</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">instance</span><span class="o">.</span><span class="n">download_url</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">instances</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">download_url</span>

<div class="viewcode-block" id="MERSCOPESection.get_section_data_paths">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.get_section_data_paths">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section_data_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>      
        <span class="n">platform</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">platform</span> <span class="c1"># don&#39;t like this but need to edit the file names to be read by Windows</span>
        <span class="c1">#dats</span>
        <span class="n">dats</span> <span class="o">=</span> <span class="n">DatsClient</span><span class="p">()</span>
        <span class="n">pts</span> <span class="o">=</span> <span class="n">PtsClient</span><span class="p">()</span>
        <span class="n">macaque_dats_account</span> <span class="o">=</span> <span class="n">dats</span><span class="o">.</span><span class="n">get_account</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;merscope_lims_code&#39;</span><span class="p">])</span>
        
        <span class="n">merscope_expt</span> <span class="o">=</span> <span class="n">pts</span><span class="o">.</span><span class="n">get_process_by_id</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">merscope_expt_pts_id</span><span class="p">)</span>
        <span class="n">spec_data_collection</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">output</span> <span class="ow">in</span> <span class="n">merscope_expt</span><span class="o">.</span><span class="n">outputs</span><span class="p">:</span> 
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dats_collection</span> <span class="o">=</span> <span class="n">dats</span><span class="o">.</span><span class="n">get_collection_by_id</span><span class="p">(</span><span class="n">account_id</span> <span class="o">=</span> <span class="n">macaque_dats_account</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">collection_id</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">external_id</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">dats_collection</span><span class="o">.</span><span class="n">description</span> <span class="o">==</span> <span class="s1">&#39;merfish_output&#39;</span> <span class="ow">and</span> <span class="n">dats_collection</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;File Bundle&#39;</span><span class="p">:</span>
                    <span class="n">spec_data_collection</span> <span class="o">=</span> <span class="n">dats_collection</span>
                    <span class="k">break</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">pass</span>
        
        <span class="k">assert</span> <span class="n">spec_data_collection</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;No merfish_output collection found for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">barcode</span><span class="si">}</span><span class="s1"> with Isilon instances. Data paths cannot be determined&#39;</span>
        <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="n">spec_data_collection</span><span class="o">.</span><span class="n">digital_assets</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">asset</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;CSV&#39;</span> <span class="ow">and</span> <span class="s1">&#39;detected_transcripts&#39;</span> <span class="ow">in</span> <span class="n">asset</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_dats_instances</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_file</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_file</span>
            <span class="k">if</span> <span class="n">asset</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="s1">&#39;Directory&#39;</span> <span class="ow">and</span> <span class="s1">&#39;images&#39;</span> <span class="ow">in</span> <span class="n">asset</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filter_dats_instances</span><span class="p">(</span><span class="n">asset</span><span class="o">.</span><span class="n">instances</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">platform</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;win&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">images_path</span> <span class="o">=</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_path</span>

        <span class="k">assert</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;detected_transcripts_file&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;images_path&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;No detected_transcripts or images found for </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">barcode</span><span class="si">}</span><span class="s1">, check Allen Services query&#39;</span></div>

                
<div class="viewcode-block" id="MERSCOPESection.load_spottable">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.load_spottable">[docs]</a>
    <span class="k">def</span> <span class="nf">load_spottable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;detected_transcripts_cache&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;detected_transcripts.npz&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;images_path&#39;</span><span class="p">):</span>
            <span class="n">spot_table</span> <span class="o">=</span> <span class="n">SpotTable</span><span class="o">.</span><span class="n">load_merscope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_cache</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">images_path</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">spot_table</span> <span class="o">=</span> <span class="n">SpotTable</span><span class="o">.</span><span class="n">load_merscope</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_cache</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spot_table</span></div>


<div class="viewcode-block" id="MERSCOPESection.run_segmentation_on_section">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.run_segmentation_on_section">[docs]</a>
    <span class="k">def</span> <span class="nf">run_segmentation_on_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">subrgn</span><span class="p">,</span> <span class="n">seg_method</span><span class="p">,</span> <span class="n">seg_opts</span><span class="p">,</span> <span class="n">hpc_opts</span><span class="p">):</span>
        <span class="c1"># generate a new timestamp for segmentation</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">segmentation_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span>
        <span class="n">individual_seg_dir</span> <span class="o">=</span> <span class="n">segmentation_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">individual_seg_dir</span><span class="p">)</span>
        <span class="n">seg_run</span> <span class="o">=</span> <span class="n">MerscopeSegmentationRun</span><span class="o">.</span><span class="n">from_spatial_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">individual_seg_dir</span><span class="p">,</span> <span class="n">subrgn</span><span class="p">,</span> <span class="n">seg_method</span><span class="p">,</span> <span class="n">seg_opts</span><span class="p">,</span> <span class="n">hpc_opts</span><span class="p">)</span>
        <span class="n">spot_table</span><span class="p">,</span> <span class="n">cell_by_gene</span> <span class="o">=</span> <span class="n">seg_run</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">use_prod_cids</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">cell_by_gene</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                    <span class="s1">&#39;seg_timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span>
                    <span class="s1">&#39;seg_params&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_segmentation_status</span><span class="p">()[</span><span class="n">timestamp</span><span class="p">],</span>
                    <span class="p">})</span>

        <span class="k">return</span> <span class="n">timestamp</span><span class="p">,</span> <span class="n">spot_table</span><span class="p">,</span> <span class="n">cell_by_gene</span></div>


<div class="viewcode-block" id="MERSCOPESection.load_segmentation_results">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.load_segmentation_results">[docs]</a>
    <span class="k">def</span> <span class="nf">load_segmentation_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="c1"># useful for attempting to load results from older segmentations</span>
        <span class="c1"># that don&#39;t have metadata pkl files</span>
        <span class="n">segmentation_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span>
        <span class="n">individual_seg_dir</span> <span class="o">=</span> <span class="n">segmentation_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">timestamp</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">individual_seg_dir</span><span class="p">)</span>

        <span class="n">cid_path</span> <span class="o">=</span> <span class="n">individual_seg_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;segmentation.npy&#39;</span><span class="p">)</span>
        <span class="n">cbg_path</span> <span class="o">=</span> <span class="n">individual_seg_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;cell_by_gene.h5ad&#39;</span><span class="p">)</span>

        <span class="n">cell_ids</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">cid_path</span><span class="p">)</span>
        <span class="n">cell_by_gene</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">cbg_path</span><span class="p">)</span>
        <span class="n">spot_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_spottable</span><span class="p">()</span>
        <span class="n">spot_table</span><span class="o">.</span><span class="n">cell_ids</span> <span class="o">=</span> <span class="n">cell_ids</span>

        <span class="k">return</span> <span class="n">spot_table</span><span class="p">,</span> <span class="n">cell_by_gene</span></div>


<div class="viewcode-block" id="MERSCOPESection.calc_cell_qc_metrics">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.calc_cell_qc_metrics">[docs]</a>
    <span class="k">def</span> <span class="nf">calc_cell_qc_metrics</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_by_gene</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate basic qc parameters and add them to the cell by gene</span>
<span class="sd">        table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cbg_copy</span> <span class="o">=</span> <span class="n">cell_by_gene</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">n_transcripts</span> <span class="o">=</span> <span class="n">calc_n_transcripts</span><span class="p">(</span><span class="n">cell_by_gene</span><span class="p">)</span>
        <span class="n">n_genes</span> <span class="o">=</span> <span class="n">calc_n_genes</span><span class="p">(</span><span class="n">cell_by_gene</span><span class="p">)</span>
        
        <span class="n">n_blanks</span> <span class="o">=</span> <span class="n">calc_n_blanks</span><span class="p">(</span><span class="n">cell_by_gene</span><span class="p">)</span>
        <span class="n">pct_blanks</span> <span class="o">=</span> <span class="n">n_blanks</span><span class="o">*</span><span class="mi">100</span> <span class="o">/</span> <span class="n">n_transcripts</span>
        
        <span class="n">cell_by_gene</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;probe_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cell_by_gene</span><span class="o">.</span><span class="n">var_names</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Blank&#39;</span><span class="p">)</span>
        <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;n_transcripts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_transcripts</span>
        <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;n_genes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">n_genes</span>
        <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;pct_counts_blank&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pct_blanks</span>

        <span class="k">return</span> <span class="n">cbg_copy</span></div>


<div class="viewcode-block" id="MERSCOPESection.run_qc_filtering_on_section">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.run_qc_filtering_on_section">[docs]</a>
    <span class="k">def</span> <span class="nf">run_qc_filtering_on_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_by_gene</span><span class="p">,</span> <span class="n">qc_params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span> <span class="n">use_cols</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span><span class="o">|</span><span class="kc">None</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Filter cells based on defined qc params. Keys of qc_params must be</span>
<span class="sd">        in the cell_by_gene.obs.</span>

<span class="sd">        Note that the cell_by_gene table is not subset; instead, a column</span>
<span class="sd">        cell_qc_pass is created that indicates whether cells passed or failed</span>
<span class="sd">        any qc thresholds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">cbg_copy</span> <span class="o">=</span> <span class="n">cell_by_gene</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span> <span class="ow">in</span> <span class="n">qc_params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">_toolow_qc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lower</span>
            <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">param</span><span class="si">}</span><span class="s1">_toohigh_qc&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">param</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">upper</span>

        <span class="k">if</span> <span class="n">use_cols</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># use all qc params for filtering</span>
            <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;cell_qc_pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;_qc&#39;</span><span class="p">)]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># use only indicated columns</span>
            <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;cell_qc_pass&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="o">~</span><span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">use_cols</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">cbg_copy</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;qc_params&#39;</span><span class="p">:</span> <span class="n">qc_params</span><span class="p">})</span>

        <span class="k">return</span> <span class="n">cbg_copy</span></div>


<div class="viewcode-block" id="MERSCOPESection.check_doublet_detection_status">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.check_doublet_detection_status">[docs]</a>
    <span class="k">def</span> <span class="nf">check_doublet_detection_status</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">doublet_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qc_path</span>
        <span class="n">dd_runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">scandir</span><span class="p">(</span><span class="n">doublet_dir</span><span class="p">)</span> <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dd_runs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">dd_runs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">run_name</span> <span class="ow">in</span> <span class="n">dd_runs</span><span class="p">:</span>
                <span class="n">output</span> <span class="o">=</span> <span class="n">doublet_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="s1">&#39;cell_by_gene_doublets.h5ad&#39;</span><span class="p">)</span>
                <span class="n">dd_info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;finished&#39;</span><span class="p">:</span> <span class="n">output</span><span class="o">.</span><span class="n">exists</span><span class="p">()}</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dd_meta_file</span> <span class="o">=</span> <span class="n">doublet_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">run_name</span><span class="p">,</span> <span class="s1">&#39;doublet_detection_params.json&#39;</span><span class="p">)</span>
                    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dd_meta_file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                        <span class="n">dd_meta</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="n">dd_info</span><span class="p">[</span><span class="s1">&#39;doublet_params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd_meta</span>
                <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>
                    <span class="k">pass</span>

                <span class="n">status</span><span class="p">[</span><span class="n">run_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">dd_info</span>

        <span class="k">return</span> <span class="n">status</span></div>


<div class="viewcode-block" id="MERSCOPESection.run_doublet_detection_on_section">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.run_doublet_detection_on_section">[docs]</a>
    <span class="k">def</span> <span class="nf">run_doublet_detection_on_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_by_gene</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">method_kwargs</span><span class="p">,</span> <span class="n">hpc_args</span><span class="p">,</span> <span class="n">filter_col</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Submits a job to run doublet detection on a GPU node on the HPC.&quot;&quot;&quot;</span>
        <span class="n">timestamp</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y%m</span><span class="si">%d</span><span class="s1">_%H%M%S&#39;</span><span class="p">)</span>
        <span class="n">doublet_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qc_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">timestamp</span><span class="p">)</span>
        <span class="n">doublet_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>

        <span class="n">run_spec</span> <span class="o">=</span> <span class="p">(</span><span class="n">run_doublet_detection</span><span class="p">,</span> <span class="p">(),</span> <span class="p">{</span>
            <span class="s1">&#39;cell_by_gene&#39;</span><span class="p">:</span> <span class="n">cell_by_gene</span><span class="p">,</span> 
            <span class="s1">&#39;output_dir&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">doublet_dir</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">,</span>
            <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="n">method</span><span class="p">,</span> 
            <span class="s1">&#39;method_kwargs&#39;</span><span class="p">:</span> <span class="n">method_kwargs</span><span class="p">,</span>
            <span class="s1">&#39;filter_col&#39;</span><span class="p">:</span> <span class="n">filter_col</span>
            <span class="p">}</span>
        <span class="p">)</span>

        <span class="n">job_path</span> <span class="o">=</span> <span class="n">doublet_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;hpc_jobs&#39;</span><span class="p">)</span>
        <span class="n">job_path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">hpc_config</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;run_spec&#39;</span><span class="p">:</span> <span class="n">run_spec</span><span class="p">,</span>
                <span class="s1">&#39;conda_env&#39;</span><span class="p">:</span> <span class="s1">&#39;/allen/programs/celltypes/workgroups/rnaseqanalysis/NHP_spatial/seg_tests/conda-envs/sis_test/&#39;</span><span class="p">,</span>
                <span class="s1">&#39;hpc_host&#39;</span><span class="p">:</span> <span class="s1">&#39;hpc-login&#39;</span><span class="p">,</span>  <span class="c1"># change to &#39;localhost&#39; if running from hpc</span>
                <span class="s1">&#39;job_path&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">job_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s1">/&#39;</span><span class="p">,</span>
                <span class="s1">&#39;partition&#39;</span><span class="p">:</span> <span class="s1">&#39;celltypes&#39;</span><span class="p">,</span>
                <span class="s1">&#39;job_name&#39;</span><span class="p">:</span> <span class="s1">&#39;doublet_det&#39;</span><span class="p">,</span>
                <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;ntasks&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;mincpus&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;gpus_per_node&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;mem&#39;</span><span class="p">:</span> <span class="s1">&#39;20G&#39;</span><span class="p">,</span>
                <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="s1">&#39;02:00:00&#39;</span><span class="p">,</span>
                <span class="s1">&#39;mail_user&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">hpc_config</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="o">**</span><span class="n">hpc_args</span><span class="p">)</span>
        <span class="n">jobs</span> <span class="o">=</span> <span class="n">run_slurm_func</span><span class="p">(</span><span class="o">**</span><span class="n">hpc_config</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Job ID: &#39;</span><span class="p">,</span> <span class="n">jobs</span><span class="o">.</span><span class="n">base_job_id</span><span class="p">)</span>
        <span class="n">d_out</span> <span class="o">=</span> <span class="n">doublet_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;doublet_results.csv&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="n">d_out</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">jobs</span><span class="o">.</span><span class="n">state</span><span class="p">())</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>

        <span class="n">doublet_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">d_out</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">meta_file</span> <span class="o">=</span> <span class="n">doublet_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;doublet_detection_params.json&#39;</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">meta_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">doublet_meta</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="n">doublet_df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">doublet_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
        <span class="n">cbg_copy</span> <span class="o">=</span> <span class="n">cell_by_gene</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span> <span class="o">=</span> <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">doublet_df</span><span class="p">[</span><span class="s1">&#39;doublet_score&#39;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;left&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;doublet_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;doublet_score&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;qc_failed&#39;</span><span class="p">)</span>
        <span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;doublet_score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">cbg_copy</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;doublet_score&#39;</span><span class="p">],</span> <span class="n">categories</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;qc_failed&#39;</span><span class="p">,</span> <span class="s1">&#39;singlet&#39;</span><span class="p">,</span> <span class="s1">&#39;doublet&#39;</span><span class="p">])</span>
        <span class="n">cbg_copy</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s1">&#39;doublet_timestamp&#39;</span><span class="p">:</span> <span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;doublet_params&#39;</span><span class="p">:</span> <span class="n">doublet_meta</span><span class="p">})</span> 
        
        <span class="n">doublet_ad_path</span> <span class="o">=</span> <span class="n">doublet_dir</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;cell_by_gene_doublets.h5ad&#39;</span><span class="p">)</span>
        <span class="n">cbg_copy</span><span class="o">.</span><span class="n">write_h5ad</span><span class="p">(</span><span class="n">doublet_ad_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cbg_copy</span><span class="p">,</span> <span class="n">timestamp</span></div>


<div class="viewcode-block" id="MERSCOPESection.load_doublet_anndata">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.load_doublet_anndata">[docs]</a>
    <span class="k">def</span> <span class="nf">load_doublet_anndata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">):</span>
        <span class="n">doublet_ad_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qc_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">timestamp</span><span class="p">,</span> <span class="s1">&#39;cell_by_gene_doublets.h5ad&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">doublet_ad_path</span><span class="p">)</span></div>


<div class="viewcode-block" id="MERSCOPESection.make_anndata">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.make_anndata">[docs]</a>
    <span class="k">def</span> <span class="nf">make_anndata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cell_by_gene</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="s1">&#39;sp_anndata.h5ad&#39;</span><span class="p">):</span>
        <span class="n">sp_anndata_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span>
        <span class="n">cell_by_gene</span><span class="o">.</span><span class="n">write_h5ad</span><span class="p">(</span><span class="n">sp_anndata_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">anndata_file</span> <span class="o">=</span> <span class="n">sp_anndata_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dataset</span><span class="p">()</span></div>


<div class="viewcode-block" id="MERSCOPESection.run_mapping_on_section">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.run_mapping_on_section">[docs]</a>
    <span class="k">def</span> <span class="nf">run_mapping_on_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">taxonomy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">method_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">hpc_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="n">ScrattchMapping</span><span class="p">:</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="n">ScrattchMapping</span><span class="p">(</span>
                <span class="n">sp_data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">anndata_file</span><span class="p">,</span>
                <span class="n">taxonomy_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;taxonomy_info&#39;</span><span class="p">][</span><span class="n">taxonomy</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">],</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;taxonomy_name&#39;</span><span class="p">:</span> <span class="n">taxonomy</span><span class="p">,</span> <span class="s1">&#39;taxonomy_cols&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;taxonomy_info&#39;</span><span class="p">][</span><span class="n">taxonomy</span><span class="p">][</span><span class="s1">&#39;col_labels&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mapping method not instantiated for </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="n">ad_map_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;save_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()}</span>
        <span class="n">ad_map_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">method_args</span><span class="p">)</span>
        
        <span class="n">hpc_args_default</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;job_path&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hpc_outputs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/scripts/&quot;</span><span class="p">,</span>
            <span class="s1">&#39;output&#39;</span><span class="p">:</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hpc_outputs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/%j.out&quot;</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hpc_outputs&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/%j.err&quot;</span><span class="p">,</span>
        <span class="p">}</span>
        
        <span class="n">hpc_args_default</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hpc_args</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s1">&#39;docker&#39;</span> <span class="ow">in</span> <span class="n">hpc_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">docker</span> <span class="o">=</span> <span class="n">hpc_args</span><span class="p">[</span><span class="s1">&#39;docker&#39;</span><span class="p">]</span>
            <span class="n">hpc_args_default</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;docker&#39;</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">run_on_hpc</span><span class="p">(</span><span class="n">ad_map_args</span><span class="p">,</span> <span class="n">hpc_args_default</span><span class="p">,</span> <span class="n">docker</span><span class="o">=</span><span class="n">docker</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">run_on_hpc</span><span class="p">(</span><span class="n">ad_map_args</span><span class="p">,</span> <span class="n">hpc_args_default</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">job</span><span class="p">,</span> <span class="n">mapping</span>    </div>


<div class="viewcode-block" id="MERSCOPESection.make_cirro">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.MERSCOPESection.make_cirro">[docs]</a>
    <span class="k">def</span> <span class="nf">make_cirro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ct_map</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ct_map</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ct_map</span> <span class="o">=</span> <span class="n">CellTypeMapping</span><span class="o">.</span><span class="n">load_from_timestamp</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">ct_map</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_map</span><span class="p">,</span> <span class="n">ScrattchMapping</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ct_map</span><span class="p">,</span> <span class="s1">&#39;ad_map&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">ct_map</span><span class="o">.</span><span class="n">load_scrattch_mapping_results</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s1">&#39;raw_counts&#39;</span> <span class="ow">in</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">raw_dat</span> <span class="o">=</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">to_df</span><span class="p">(</span><span class="n">layer</span><span class="o">=</span><span class="s1">&#39;raw_counts&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">raw_dat</span> <span class="o">=</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">to_df</span><span class="p">()</span>
            
        <span class="n">ct_map</span><span class="o">.</span><span class="n">spatial_umap</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="s1">&#39;ad_map&#39;</span><span class="p">)</span>
        <span class="n">x_umap</span> <span class="o">=</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s1">&#39;umap_x&#39;</span><span class="p">,</span> <span class="s1">&#39;umap_y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>
        <span class="n">spatial</span> <span class="o">=</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="p">[[</span><span class="s1">&#39;center_x&#39;</span><span class="p">,</span> <span class="s1">&#39;center_y&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="n">obsm</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;spatial&#39;</span><span class="p">:</span> <span class="n">spatial</span><span class="p">,</span>
                <span class="s1">&#39;X_umap&#39;</span><span class="p">:</span> <span class="n">x_umap</span><span class="p">,</span>
            <span class="p">}</span> 

        <span class="n">X</span> <span class="o">=</span> <span class="n">raw_dat</span><span class="p">[</span><span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">()]</span>

        <span class="n">var</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>

        <span class="n">ad_cirro</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">AnnData</span><span class="p">(</span>
            <span class="n">X</span> <span class="o">=</span> <span class="n">X</span><span class="p">,</span>
            <span class="n">obs</span> <span class="o">=</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span>
            <span class="n">var</span> <span class="o">=</span> <span class="n">var</span><span class="p">,</span>
            <span class="n">obsm</span> <span class="o">=</span> <span class="n">obsm</span><span class="p">,</span>
            <span class="n">uns</span> <span class="o">=</span> <span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">uns</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">cirro_file</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">ct_map</span><span class="o">.</span><span class="n">run_directory</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ad_cirro_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">lims_specimen_name</span><span class="si">}</span><span class="s1">.h5ad&#39;</span><span class="p">)</span>
        <span class="n">ad_cirro</span><span class="o">.</span><span class="n">write_h5ad</span><span class="p">(</span><span class="n">cirro_file</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">cirro_file</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cirro_file</span></div>
</div>


<span class="c1"># class MERSCOPESectionCollection(MERSCOPESection):</span>
<span class="c1">#     #collection of MERSCOPE sections that go together</span>

<div class="viewcode-block" id="StereoSeqSection">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection">[docs]</a>
<span class="k">class</span> <span class="nc">StereoSeqSection</span><span class="p">(</span><span class="n">SpatialDataset</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">barcode</span><span class="p">):</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">load_config</span><span class="p">()</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;stereoseq_save_path&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Path</span><span class="o">.</span><span class="n">is_file</span><span class="p">(</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;spatial_dataset&#39;</span><span class="p">)):</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;SpatialDataset already exists and will be loaded. If you want to reprocess this dataset delete the file and start over&#39;</span><span class="p">)</span>
            <span class="n">cached</span> <span class="o">=</span> <span class="n">SpatialDataset</span><span class="o">.</span><span class="n">load_from_barcode</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span> <span class="n">StereoSeqSection</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">cached</span><span class="o">.</span><span class="vm">__dict__</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;QC status:&#39;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qc</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">SpatialDataset</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">barcode</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span> <span class="o">=</span> <span class="n">save_path</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">):</span>
                <span class="n">Path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">xyscale</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">broad_region</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;mapping_dir&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mapping_dir&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span><span class="p">):</span>
                <span class="n">Path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;segmentation_dir&#39;</span><span class="p">])</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;segmentation_dir&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">Path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span><span class="p">):</span>
                <span class="n">Path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">segmentation_path</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">qc</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;bin200_median_transcript&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;bin200_transcript_coverage&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;corr_to_bulk&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;corr_to_pair&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;visual_inspection&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;gene_expression&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="s1">&#39;celltype_mapping&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">get_section_metadata</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_section_data_paths</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">save_dataset</span><span class="p">()</span> 
        
<div class="viewcode-block" id="StereoSeqSection.set_partner_chips">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.set_partner_chips">[docs]</a>
    <span class="k">def</span> <span class="nf">set_partner_chips</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">barcodes</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partner_chips</span> <span class="o">=</span> <span class="n">barcodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dataset</span><span class="p">()</span></div>


<div class="viewcode-block" id="StereoSeqSection.get_section_data_paths">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.get_section_data_paths">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section_data_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># hopefully this will get integrated into Allen Services but for now, hardcode paths</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_file</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;gem_files&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">barcode</span> <span class="o">+</span> <span class="s1">&#39;.tissue.gem&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin_file</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;gem_files&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">barcode</span> <span class="o">+</span> <span class="s1">&#39;.tissue.gef&#39;</span><span class="p">))</span>
        <span class="n">cellbin_file</span> <span class="o">=</span>  <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;gem_files&#39;</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">barcode</span> <span class="o">+</span> <span class="s1">&#39;.cellbin.gef&#39;</span><span class="p">))</span>
        <span class="n">image_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;ssDNA_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">barcode</span><span class="si">}</span><span class="s1">_regist.tif&#39;</span><span class="p">)</span>
        <span class="c1"># we might not always download the image file or the cellbin file:</span>
        <span class="k">if</span> <span class="n">image_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">image_file</span> <span class="o">=</span> <span class="n">image_file</span>
        <span class="k">if</span> <span class="n">cellbin_file</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cellbin_file</span> <span class="o">=</span> <span class="n">cellbin_file</span></div>

    
<div class="viewcode-block" id="StereoSeqSection.get_section_metadata">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.get_section_metadata">[docs]</a>
    <span class="k">def</span> <span class="nf">get_section_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># hopefully this will get integrated into Allen Services but for now, hardcode </span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">species</span> <span class="o">=</span> <span class="s1">&#39;Macaque&#39;</span></div>

        
<div class="viewcode-block" id="StereoSeqSection.load_spottable">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.load_spottable">[docs]</a>
    <span class="k">def</span> <span class="nf">load_spottable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>       
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;detected_transcripts_cache&#39;</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_cache</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;detected_transcripts.npz&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;image_file&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">Path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_file</span><span class="p">)</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
            <span class="n">spot_table</span> <span class="o">=</span> <span class="n">SpotTable</span><span class="o">.</span><span class="n">load_stereoseq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_cache</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">image_file</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">image_file</span><span class="p">,</span> <span class="n">image_channel</span><span class="o">=</span><span class="s1">&#39;nuclear&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">spot_table</span> <span class="o">=</span> <span class="n">SpotTable</span><span class="o">.</span><span class="n">load_stereoseq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">detected_transcripts_cache</span><span class="p">,</span> <span class="n">skiprows</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">spot_table</span></div>

        
<div class="viewcode-block" id="StereoSeqSection.qc_widget">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.qc_widget">[docs]</a>
    <span class="k">def</span> <span class="nf">qc_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="p">):</span>
        <span class="n">interact_manual</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">evaluate_qc_metric</span><span class="p">,</span> <span class="n">qc_metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">qc</span><span class="o">=</span><span class="n">widgets</span><span class="o">.</span><span class="n">Dropdown</span><span class="p">(</span>
                            <span class="n">options</span><span class="o">=</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;Pass&#39;</span><span class="p">,</span> <span class="s1">&#39;Fail&#39;</span><span class="p">],</span>
                            <span class="n">description</span><span class="o">=</span><span class="s1">&#39;QC result:&#39;</span><span class="p">,</span>
                            <span class="n">value</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">disabled</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">style</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;description_width&#39;</span><span class="p">:</span> <span class="s1">&#39;initial&#39;</span><span class="p">},</span>
                        <span class="p">))</span></div>

        
<div class="viewcode-block" id="StereoSeqSection.evaluate_qc_metric">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.evaluate_qc_metric">[docs]</a>
    <span class="k">def</span> <span class="nf">evaluate_qc_metric</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qc_metric</span><span class="p">,</span> <span class="n">qc</span><span class="p">):</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">qc</span><span class="p">[</span><span class="n">qc_metric</span><span class="p">]</span> <span class="o">=</span> <span class="n">qc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">save_dataset</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">qc_metric</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">qc</span><span class="p">[</span><span class="n">qc_metric</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="StereoSeqSection.qc_gene_expression">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.qc_gene_expression">[docs]</a>
    <span class="k">def</span> <span class="nf">qc_gene_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gene_list</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">spot_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="c1"># optionally provide a spot table if one is already loaded</span>
        <span class="k">if</span> <span class="n">spot_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">spot_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_spottable</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">gene_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">gene_list</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;stereoseq_qc_genes_file&#39;</span><span class="p">])</span>
            <span class="n">gene_list</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;gene expression pattern&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">gene_list</span> <span class="o">=</span> <span class="n">gene_list</span><span class="p">[</span><span class="s1">&#39;gene&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

        <span class="n">rows</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gene_list</span><span class="p">)</span> <span class="o">/</span> <span class="n">rows</span><span class="p">))</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">cols</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">4</span><span class="o">*</span><span class="n">cols</span><span class="p">))</span>
        <span class="n">row</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">gene</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">gene_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">i</span> <span class="o">%</span> <span class="n">rows</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">row</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="n">col</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">spot_table</span><span class="o">.</span><span class="n">get_genes</span><span class="p">(</span><span class="n">gene_names</span><span class="o">=</span><span class="p">[</span><span class="n">gene</span><span class="p">])</span><span class="o">.</span><span class="n">show_binned_heatmap</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">row</span><span class="p">,</span> <span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">gene</span><span class="p">)</span>
            <span class="n">col</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">save_fig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;gene_expression_qc.png&#39;</span><span class="p">))</span>


        <span class="bp">self</span><span class="o">.</span><span class="n">qc_widget</span><span class="p">(</span><span class="n">metric</span><span class="o">=</span><span class="s1">&#39;gene_expression&#39;</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="StereoSeqSection.qc_spatial_corr_to_bulk">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.qc_spatial_corr_to_bulk">[docs]</a>
    <span class="k">def</span> <span class="nf">qc_spatial_corr_to_bulk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.6</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{}):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_corr_to_bulk</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qc</span><span class="p">[</span><span class="s1">&#39;corr_to_bulk&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Pass&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_to_bulk</span> <span class="o">&gt;=</span> <span class="n">threshold</span> <span class="k">else</span> <span class="s1">&#39;Fail&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;corr_to_bulk: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">qc</span><span class="p">[</span><span class="s1">&#39;corr_to_bulk&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>

        
<div class="viewcode-block" id="StereoSeqSection.qc_bin200">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.qc_bin200">[docs]</a>
    <span class="k">def</span> <span class="nf">qc_bin200</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">median_transcript_thresh</span><span class="o">=</span><span class="mi">18000</span><span class="p">,</span> <span class="n">base_transcript_thresh</span><span class="o">=</span><span class="mi">7000</span><span class="p">,</span> <span class="n">save_fig</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="kn">import</span> <span class="nn">stereo</span> <span class="k">as</span> <span class="nn">st</span>

        <span class="n">ad200_file</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;ad_sp_bin200.h5ad&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="o">.</span><span class="n">is_file</span><span class="p">(</span><span class="n">ad200_file</span><span class="p">):</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;chip_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">barcode</span><span class="p">,</span>
                    <span class="s1">&#39;binsize&#39;</span><span class="p">:</span> <span class="s1">&#39;200&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span>
                    <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">broad_region</span><span class="p">,</span>
                    <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;StereoSeq&#39;</span><span class="p">,</span>
                   <span class="p">}</span>  
            <span class="n">bin200_data</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_gef</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_file</span><span class="p">),</span> <span class="n">bin_size</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
            <span class="n">bin200_data</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">raw_checkpoint</span><span class="p">()</span>
            <span class="n">bin200_data</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">cal_qc</span><span class="p">()</span>
            <span class="n">ad_bin200</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">stereo_to_anndata</span><span class="p">(</span><span class="n">bin200_data</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;scanpy&#39;</span><span class="p">,</span> <span class="n">reindex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span> <span class="n">ad200_file</span><span class="p">)</span>
            <span class="n">ad_bin200</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="n">ad_bin200</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;center_x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;center_y&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ad_bin200</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;center_x&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyscale</span>
            <span class="n">ad_bin200</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;center_y&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyscale</span>
            <span class="n">ad_bin200</span><span class="o">.</span><span class="n">write_h5ad</span><span class="p">(</span><span class="n">ad200_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ad_bin200</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">ad200_file</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bin200_median_transcript</span> <span class="o">=</span> <span class="n">ad_bin200</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;total_counts&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bin200_transcript_coverage</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ad_bin200</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">ad_bin200</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;total_counts&#39;</span><span class="p">]</span><span class="o">&gt;</span><span class="n">base_transcript_thresh</span><span class="p">])</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ad_bin200</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_qc_metric</span><span class="p">(</span><span class="s1">&#39;bin200_median_transcript&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin200_median_transcript</span> <span class="o">&gt;=</span> <span class="n">median_transcript_thresh</span> <span class="k">else</span> <span class="s1">&#39;Fail&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_qc_metric</span><span class="p">(</span><span class="s1">&#39;bin200_transcript_coverage&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin200_transcript_coverage</span> <span class="o">&gt;=</span> <span class="mi">80</span> <span class="k">else</span> <span class="s1">&#39;Fail&#39;</span><span class="p">)</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ad_bin200</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;total_counts&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cut</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">median_transcript_thresh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Median MID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bin200_median_transcript</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">ecdfplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ad_bin200</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="s1">&#39;total_counts&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">base_transcript_thresh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  
        <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;% Bins &gt; Base MID: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">bin200_transcript_coverage</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">%&#39;</span><span class="p">)</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">violinplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ad_bin200</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s1">&#39;n_genes_by_counts&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">cut</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">save_fig</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span> <span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;Bin200_transcript_detection.png&#39;</span><span class="p">))</span></div>

    
<div class="viewcode-block" id="StereoSeqSection.run_mapping_on_section">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.run_mapping_on_section">[docs]</a>
    <span class="k">def</span> <span class="nf">run_mapping_on_section</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">binsize</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">taxonomy</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">training_genes</span><span class="o">=</span><span class="s1">&#39;hvgs&#39;</span><span class="p">,</span> <span class="n">method_args</span><span class="o">=</span><span class="p">{},</span> <span class="n">hpc_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="kn">import</span> <span class="nn">stereo</span> <span class="k">as</span> <span class="nn">st</span>

        <span class="n">bin_key</span> <span class="o">=</span> <span class="s1">&#39;bin&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">binsize</span><span class="p">)</span> <span class="k">if</span> <span class="n">binsize</span> <span class="o">!=</span> <span class="s1">&#39;cell&#39;</span> <span class="k">else</span> <span class="n">binsize</span>
        <span class="n">ad_file</span> <span class="o">=</span> <span class="n">Path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="p">,</span> <span class="s1">&#39;ad_sp_&#39;</span> <span class="o">+</span> <span class="n">bin_key</span> <span class="o">+</span> <span class="s1">&#39;.h5ad&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">Path</span><span class="o">.</span><span class="n">is_file</span><span class="p">(</span><span class="n">ad_file</span><span class="p">):</span>
            <span class="n">uns</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;chip_name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">barcode</span><span class="p">,</span>
                <span class="s1">&#39;binsize&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">binsize</span><span class="p">),</span>
                <span class="s1">&#39;species&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">species</span><span class="p">,</span>
                <span class="s1">&#39;region&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">broad_region</span><span class="p">,</span>
                <span class="s1">&#39;method&#39;</span><span class="p">:</span> <span class="s1">&#39;StereoSeq&#39;</span><span class="p">,</span>
                <span class="p">}</span>
            
            <span class="k">if</span> <span class="n">binsize</span> <span class="o">==</span> <span class="s1">&#39;cell&#39;</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_gef</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cellbin_file</span><span class="p">),</span> <span class="n">bin_type</span><span class="o">=</span><span class="s1">&#39;cell_bins&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">read_gef</span><span class="p">(</span><span class="n">file_path</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">bin_file</span><span class="p">),</span> <span class="n">bin_size</span><span class="o">=</span><span class="n">binsize</span><span class="p">)</span>
            
            <span class="n">data</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">raw_checkpoint</span><span class="p">()</span>
            <span class="n">data</span><span class="o">.</span><span class="n">tl</span><span class="o">.</span><span class="n">cal_qc</span><span class="p">()</span>
            <span class="n">ad_data</span> <span class="o">=</span> <span class="n">st</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">stereo_to_anndata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">flavor</span><span class="o">=</span><span class="s1">&#39;scanpy&#39;</span><span class="p">,</span> <span class="n">reindex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">output</span><span class="o">=</span> <span class="n">ad_file</span><span class="p">)</span>
            <span class="n">ad_data</span><span class="o">.</span><span class="n">uns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">uns</span><span class="p">)</span>
            <span class="n">ad_data</span><span class="o">.</span><span class="n">layers</span><span class="p">[</span><span class="s1">&#39;logcounts&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">ad_data</span><span class="o">.</span><span class="n">X</span><span class="p">)</span>
            <span class="n">ad_data</span><span class="o">.</span><span class="n">obs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;center_x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;center_y&#39;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">ad_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;center_x&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyscale</span>
            <span class="n">ad_data</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="s1">&#39;center_y&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xyscale</span> 
            <span class="n">ad_data</span><span class="o">.</span><span class="n">write_h5ad</span><span class="p">(</span><span class="n">ad_file</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ad_data</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">ad_file</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">taxonomy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">taxonomy_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;taxonomy_info&#39;</span><span class="p">][</span><span class="n">taxonomy</span><span class="p">][</span><span class="s1">&#39;path&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="n">ScrattchMapping</span><span class="p">:</span>
            <span class="n">mapping</span> <span class="o">=</span> <span class="n">ScrattchMapping</span><span class="p">(</span>
                <span class="n">sp_data</span> <span class="o">=</span> <span class="n">ad_data</span><span class="p">,</span>
                <span class="n">taxonomy_path</span> <span class="o">=</span> <span class="n">taxonomy_path</span><span class="p">,</span>
                <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;taxonomy_name&#39;</span><span class="p">:</span> <span class="n">taxonomy</span><span class="p">,</span> <span class="s1">&#39;taxonomy_cols&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;taxonomy_info&#39;</span><span class="p">][</span><span class="n">taxonomy</span><span class="p">][</span><span class="s1">&#39;col_labels&#39;</span><span class="p">]}</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mapping method not instantiated for </span><span class="si">{</span><span class="n">method</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">training_genes</span> <span class="o">==</span> <span class="s1">&#39;hvgs&#39;</span> <span class="ow">and</span> <span class="n">taxonomy</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">taxonomy_ad</span> <span class="o">=</span> <span class="n">ad</span><span class="o">.</span><span class="n">read_h5ad</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">taxonomy_path</span><span class="p">)</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;AI_taxonomy.h5ad&#39;</span><span class="p">),</span> <span class="n">backed</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">training_genes</span> <span class="o">=</span> <span class="n">taxonomy_ad</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="n">taxonomy_ad</span><span class="o">.</span><span class="n">var</span><span class="p">[</span><span class="s1">&#39;highly_variable_genes&#39;</span><span class="p">]</span><span class="o">==</span><span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
            <span class="n">meta</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;training_genes&#39;</span><span class="p">:</span> <span class="s1">&#39;taxonomy highly variable genes&#39;</span><span class="p">}</span>
       
        <span class="n">ad_map_args</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;save_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">(),</span> 
                    <span class="s1">&#39;ad_sp_layer&#39;</span><span class="p">:</span> <span class="s1">&#39;logcounts&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;training_genes&#39;</span><span class="p">:</span> <span class="n">training_genes</span><span class="p">,</span>
                    <span class="s1">&#39;meta&#39;</span><span class="p">:</span> <span class="n">meta</span><span class="p">}</span>
        <span class="n">ad_map_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">method_args</span><span class="p">)</span>

        <span class="n">hpc_args_default</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;job_path&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hpc_outputs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/scripts/&#39;</span><span class="p">,</span>
            <span class="s1">&#39;output&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hpc_outputs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/%j.out&#39;</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;hpc_outputs&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;/%j.err&#39;</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">hpc_args_default</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hpc_args</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;docker&#39;</span> <span class="ow">in</span> <span class="n">hpc_args</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">docker</span> <span class="o">=</span> <span class="n">hpc_args</span><span class="p">[</span><span class="s1">&#39;docker&#39;</span><span class="p">]</span>
            <span class="n">hpc_args_default</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;docker&#39;</span><span class="p">)</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">run_on_hpc</span><span class="p">(</span><span class="n">ad_map_args</span><span class="p">,</span> <span class="n">hpc_args_default</span><span class="p">,</span> <span class="n">docker</span><span class="o">=</span><span class="n">docker</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">job</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">run_on_hpc</span><span class="p">(</span><span class="n">ad_map_args</span><span class="p">,</span> <span class="n">hpc_args_default</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">job</span><span class="p">,</span> <span class="n">mapping</span></div>

    
<div class="viewcode-block" id="StereoSeqSection.qc_mapping_results">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.qc_mapping_results">[docs]</a>
    <span class="k">def</span> <span class="nf">qc_mapping_results</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ct_map</span><span class="p">,</span> <span class="n">score_thresh</span><span class="p">,</span> <span class="n">map_thresh</span><span class="o">=</span><span class="mf">0.6</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">ct_map</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">:</span>
            <span class="n">ct_map</span> <span class="o">=</span> <span class="n">CellTypeMapping</span><span class="o">.</span><span class="n">load_from_timestamp</span><span class="p">(</span><span class="n">directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_path</span><span class="p">,</span> <span class="n">timestamp</span><span class="o">=</span><span class="n">ct_map</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ct_map</span><span class="p">,</span> <span class="n">ScrattchMapping</span><span class="p">):</span>
            <span class="n">mapping_score_col</span> <span class="o">=</span> <span class="s1">&#39;score.Corr&#39;</span>

        <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">ecdfplot</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">mapping_score_col</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">score_thresh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">map_thresh</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;orange&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>  
        
        <span class="n">ct_map</span><span class="o">.</span><span class="n">qc_mapping</span><span class="p">(</span><span class="n">qc_params</span><span class="o">=</span><span class="p">{</span><span class="n">mapping_score_col</span><span class="p">:</span> <span class="n">score_thresh</span><span class="p">})</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">mapping_quality</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="p">[</span><span class="n">mapping_score_col</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">score_thresh</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">ct_map</span><span class="o">.</span><span class="n">ad_map</span><span class="o">.</span><span class="n">obs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_qc_metric</span><span class="p">(</span><span class="s1">&#39;celltype_mapping&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapping_quality</span> <span class="o">&gt;=</span> <span class="n">map_thresh</span> <span class="k">else</span> <span class="s1">&#39;Fail&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Mapping Quality: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">mapping_quality</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;mapping_qc.png&#39;</span><span class="p">))</span>   </div>


<div class="viewcode-block" id="StereoSeqSection.qc_corr_to_pair">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSection.qc_corr_to_pair">[docs]</a>
    <span class="k">def</span> <span class="nf">qc_corr_to_pair</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">corr_thresh</span><span class="o">=</span><span class="mf">0.8</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">partner_chips</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No partner chips set&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">barcodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">partner_chips</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">barcodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">barcode</span><span class="p">)</span>
        <span class="n">collection</span> <span class="o">=</span> <span class="n">StereoSeqSectionCollection</span><span class="p">(</span><span class="n">barcode_list</span><span class="o">=</span><span class="n">barcodes</span><span class="p">)</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">collection</span><span class="o">.</span><span class="n">get_counts</span><span class="p">()</span>
        <span class="n">log_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s1">&#39;log&#39;</span> <span class="ow">in</span> <span class="n">col</span><span class="p">]</span>
        <span class="n">corr</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">log_cols</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">corr_to_pair</span> <span class="o">=</span> <span class="n">corr</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">barcode</span><span class="si">}</span><span class="s1"> log counts&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_qc_metric</span><span class="p">(</span><span class="s1">&#39;corr_to_pair&#39;</span><span class="p">,</span> <span class="s1">&#39;Pass&#39;</span> <span class="k">if</span> <span class="nb">all</span><span class="p">([</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="n">corr_thresh</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">corr_to_pair</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span> <span class="k">else</span> <span class="s1">&#39;Fail&#39;</span><span class="p">)</span>
        
        <span class="n">g</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">PairGrid</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">counts</span><span class="p">,</span> <span class="nb">vars</span><span class="o">=</span><span class="n">log_cols</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">map_diag</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">histplot</span><span class="p">)</span>
        <span class="n">g</span><span class="o">.</span><span class="n">map_offdiag</span><span class="p">(</span><span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">fig</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

        <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">counts</span><span class="p">[</span><span class="n">log_cols</span><span class="p">]</span><span class="o">.</span><span class="n">corr</span><span class="p">(),</span> <span class="n">cmap</span> <span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="n">linewidths</span> <span class="o">=</span> <span class="mf">0.30</span><span class="p">,</span> <span class="n">annot</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                    <span class="n">cbar_kws</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="s1">&#39;Pearson Corr&#39;</span><span class="p">})</span>

        <span class="n">g</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">save_path</span><span class="o">.</span><span class="n">joinpath</span><span class="p">(</span><span class="s1">&#39;corr_to_pair_qc.png&#39;</span><span class="p">))</span></div>
</div>

        
<div class="viewcode-block" id="StereoSeqSectionCollection">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSectionCollection">[docs]</a>
<span class="k">class</span> <span class="nc">StereoSeqSectionCollection</span><span class="p">(</span><span class="n">StereoSeqSection</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">barcode_list</span><span class="p">):</span>
        <span class="n">spd_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">barcode</span> <span class="ow">in</span> <span class="n">barcode_list</span><span class="p">:</span>
            <span class="n">section</span> <span class="o">=</span> <span class="n">SpatialDataset</span><span class="o">.</span><span class="n">load_from_barcode</span><span class="p">(</span><span class="n">barcode</span><span class="p">,</span> <span class="n">StereoSeqSection</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">section</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">section</span> <span class="o">=</span> <span class="n">StereoSeqSection</span><span class="p">(</span><span class="n">barcode</span><span class="p">)</span>
            <span class="n">spd_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">section</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sections</span> <span class="o">=</span> <span class="n">spd_list</span>

<div class="viewcode-block" id="StereoSeqSectionCollection.get_counts">
<a class="viewcode-back" href="../../sis.html#sis.spatial_dataset.StereoSeqSectionCollection.get_counts">[docs]</a>
    <span class="k">def</span> <span class="nf">get_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total_counts_df</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sections</span><span class="p">:</span>
            <span class="n">spot_table</span> <span class="o">=</span> <span class="n">section</span><span class="o">.</span><span class="n">load_spottable</span><span class="p">()</span>
            
            <span class="n">gene_ids</span><span class="p">,</span> <span class="n">total_counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">spot_table</span><span class="o">.</span><span class="n">gene_ids</span><span class="p">,</span> <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">genes</span> <span class="o">=</span> <span class="n">spot_table</span><span class="o">.</span><span class="n">map_gene_ids_to_names</span><span class="p">(</span><span class="n">gene_ids</span><span class="p">)</span>
            
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;gene&#39;</span><span class="p">:</span> <span class="n">genes</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">barcode</span><span class="si">}</span><span class="s1"> total counts&#39;</span><span class="p">:</span> <span class="n">total_counts</span><span class="p">,</span> 
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">section</span><span class="o">.</span><span class="n">barcode</span><span class="si">}</span><span class="s1"> log counts&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">total_counts</span><span class="p">)})</span>
            <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;gene&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">total_counts_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">total_counts_df</span> <span class="o">=</span> <span class="n">df</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total_counts_df</span> <span class="o">=</span> <span class="n">total_counts_df</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s1">&#39;outer&#39;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">total_counts_df</span></div>
</div>


<span class="c1"># class XeniumSection(SpatialDataset):</span>
<span class="c1">#     def __init__(self, barcode):</span>
<span class="c1">#         super().__init__(barcode)   </span>
<span class="c1">#         self.save_path = os.path.join(self.config[&#39;xenium_save_path&#39;], barcode)</span>
<span class="c1">#         if not os.path.exists(self.save_path):</span>
<span class="c1">#             os.mkdir(self.save_path)</span>


<span class="c1"># class XeniumSectionCollection(XeniumSection):</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">Spots-in-Spaaaaaace!</a></h1>








<h3>Navigation</h3>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Allen Spatial Analysis Working Group.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.2.6</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>